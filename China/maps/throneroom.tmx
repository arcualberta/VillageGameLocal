<?xml version="1.0" encoding="UTF-8"?>
<map version="1.0" tiledversion="1.0.3" orientation="orthogonal" renderorder="left-down" width="19" height="28" tilewidth="30" tileheight="30" nextobjectid="51">
 <tileset firstgid="1" source="throneroom.tsx"/>
 <tileset firstgid="443" source="throneobjects.tsx"/>
 <tileset firstgid="452" source="village_tiles.tsx"/>
 <tileset firstgid="1098" source="throne.tsx"/>
 <tileset firstgid="1099" name="Villager Placeholder" tilewidth="30" tileheight="50" tilecount="12" columns="3">
  <image source="../sprites/villager1.png" width="90" height="200"/>
  <tile id="6">
   <properties>
    <property name="NPC" value="Wukong"/>
   </properties>
  </tile>
 </tileset>
 <tileset firstgid="1111" source="gold4.tsx"/>
 <tileset firstgid="1112" source="gold1.tsx"/>
 <tileset firstgid="1113" source="gold2.tsx"/>
 <tileset firstgid="1114" source="gold3.tsx"/>
 <tileset firstgid="1115" source="boat.tsx"/>
 <layer name="lower" width="19" height="28">
  <data encoding="csv">
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,1111,491,
1112,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
1113,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,443,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
1114,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,491,
491,491,28,29,30,0,0,0,0,0,0,0,0,0,40,41,42,491,491,
491,491,54,55,56,0,0,0,0,0,0,0,0,0,66,67,68,491,491,
491,491,80,81,82,0,0,0,0,0,0,0,0,0,92,93,94,491,491,
908,908,106,107,108,0,0,0,0,0,0,0,0,0,118,119,120,908,908,
928,928,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,928,928,
928,928,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,928,928,
928,928,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,928,928,
928,928,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,928,928,
928,928,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,928,928,
928,928,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,928,928,
928,928,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,928,928,
928,928,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,928,928,
928,928,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,928,928,
928,928,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,928,928,
928,928,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,928,928,
928,928,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,928,928
</data>
 </layer>
 <layer name="throne_lower" width="19" height="28" opacity="0.45">
  <data encoding="csv">
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,96,97,98,99,100,101,102,103,104,0,0,0,253,253,
253,253,0,0,0,122,123,124,125,126,127,128,129,130,0,0,0,253,253,
253,253,0,0,0,148,149,150,151,152,153,154,155,156,0,0,0,253,253,
253,253,0,0,0,174,175,176,177,178,179,180,181,182,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253
</data>
 </layer>
 <layer name="middle" width="19" height="28">
  <data encoding="csv">
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,491,491,
491,491,491,491,0,0,0,254,255,256,257,258,0,0,0,0,0,491,491,
491,491,491,491,0,0,0,280,281,282,283,284,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,306,307,308,309,310,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
491,491,491,491,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,0,
0,27,0,0,0,491,491,491,491,491,491,491,491,491,0,0,0,43,0,
0,53,0,0,0,491,491,491,491,491,491,491,491,491,0,0,0,69,0,
0,79,0,0,0,491,491,491,491,491,491,491,491,491,0,0,0,95,0,
0,105,0,0,0,908,908,908,908,908,908,908,908,908,0,0,0,121,0,
794,131,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,147,0,
0,157,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,173,0,
0,183,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,199,0,
0,209,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,225,0,
0,235,0,0,0,0,229,0,0,0,0,0,229,0,0,0,0,251,0,
944,261,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,277,0,
963,287,0,0,330,0,0,0,0,0,0,0,0,0,330,0,0,303,0,
0,313,0,0,356,0,0,0,0,0,0,0,0,0,356,0,0,329,0,
0,339,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,355,0,
0,365,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,381,0,
0,391,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,407,981,
0,417,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,433,1000
</data>
 </layer>
 <layer name="throne_layer" width="19" height="28" opacity="0.44">
  <data encoding="csv">
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,253,253,
253,253,253,253,0,0,0,253,253,253,253,253,0,0,0,0,0,253,253,
253,253,253,253,0,0,0,253,253,253,253,253,0,0,0,0,0,0,0,
253,253,253,253,0,0,0,253,253,253,253,253,0,0,0,0,0,0,0,
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
253,253,253,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,18,19,20,21,22,23,24,25,26,0,0,0,0,0,
0,0,0,0,0,44,45,46,47,48,49,50,51,52,0,0,0,0,0,
0,0,0,0,0,70,71,72,73,74,75,76,77,78,0,0,0,0,0,
253,0,0,0,0,96,0,0,0,0,0,0,0,104,0,0,0,0,0,
0,0,0,0,0,0,203,0,0,0,0,0,203,0,0,0,0,0,0,
0,0,0,0,0,0,229,0,0,0,0,0,229,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253
</data>
 </layer>
 <objectgroup name="objects">
  <object id="33" name="Gold1" type="VillageObject" gid="1111" x="217.5" y="592.5" width="60" height="60" visible="0"/>
  <object id="34" name="Gold2" type="VillageObject" gid="1113" x="82.5" y="577.5" width="100" height="90" visible="0"/>
  <object id="35" name="Gold3" type="VillageObject" gid="1114" x="225" y="517.5" width="100" height="90" visible="0"/>
  <object id="36" name="Gold4" type="VillageObject" gid="1112" x="307.5" y="645" width="100" height="90" visible="0"/>
  <object id="4" name="ThroneEvent" type="VillageObject" gid="569" x="270" y="59" width="30" height="30" visible="0">
   <properties>
    <property name="onstart">this.triggerIsland = function(caller, player, world, worldAdapter){
	this.removeThrone = function(caller, player, world, worldAdapter){};
	world.getChild(&quot;throne_layer&quot;).drawEnabled = false;
	world.getChild(&quot;throne_lower&quot;).drawEnabled = false;
	world.getObject(&quot;Throne&quot;).drawEnabled = false;
	world.getObject(&quot;Lion_Top_Left&quot;).drawEnabled = false;
	world.getObject(&quot;Lion_Bottom_Left&quot;).drawEnabled = false;
	world.getObject(&quot;Lion_Top_Right&quot;).drawEnabled = false;
	world.getObject(&quot;Lion_Bottom_Right&quot;).drawEnabled = false;
}

this.closePortal =  function(caller, player, world, worldAdapter){
	world.getChild(&quot;throne_layer&quot;).drawEnabled = true;
	world.getChild(&quot;throne_lower&quot;).drawEnabled = true;
	world.getObject(&quot;Throne&quot;).drawEnabled = true;
	world.getObject(&quot;Lion_Top_Left&quot;).drawEnabled = true;
	world.getObject(&quot;Lion_Bottom_Left&quot;).drawEnabled = true;
	world.getObject(&quot;Lion_Top_Right&quot;).drawEnabled = true;
	world.getObject(&quot;Lion_Bottom_Right&quot;).drawEnabled = true;

	world.getChild(&quot;triggers&quot;).getChild(&quot;LeaveChange1&quot;).interactEnabled = true;
}

this.triggerBoat = function(caller, player, world, worldAdapter){
	world.getObject(&quot;Boat&quot;).parameters.visible = true;
}

this.loadBoat = function(caller, player, world, worldAdapter, loadCompleted){
	var boat = world.getObject(&quot;Boat&quot;);
	function loadIncrease(){
		++boat.properties.loadCount;

		if(boat.properties.loadCount == 4){
			world.getObject(&quot;Emperor&quot;).enterBoat(loadIncrease);
		}

		if(boat.properties.loadCount == 5){
			world.getObject(&quot;Guard 1&quot;).enterBoat(loadIncrease);
			world.getObject(&quot;Guard 2&quot;).enterBoat(loadIncrease);
			world.getObject(&quot;Main Guard&quot;).enterBoat(loadIncrease);
		}

		if(boat.properties.loadCount &gt;= 8){
			loadCompleted();
		}		
	}

	for(var i = 1; i &lt;= 4; ++i){
		world.objects.removeChild(&quot;Gold&quot; + i);
		 loadIncrease();
	}
}

this.rideBoat = function(caller, player, world, worldAdapter){
	game.display.camera.target = world.getObject(&quot;Boat&quot;);
	world.getObject(&quot;Boat&quot;).properties.isMoving = true;
}

this.triggerMoney = function(caller, player, world, worldAdaper){
	for(var i = 1; i &lt;= 4; ++i){
		world.getObject(&quot;Gold&quot; + i).parameters.visible = true;
	}
	console.log(&quot;Whoo money!&quot;);
}

this.triggerBanners = function(caller, player, world, worldAdapter){
	console.log(&quot;Whoo power!&quot;);
}</property>
   </properties>
  </object>
  <object id="5" name="Lion_Bottom_Left" type="VillageObject" gid="692" x="194" y="521" width="30" height="30">
   <properties>
    <property name="walkable" type="bool" value="false"/>
   </properties>
  </object>
  <object id="7" name="Lion_Bottom_Right" gid="695" x="346" y="521" width="30" height="30">
   <properties>
    <property name="walkable" type="bool" value="false"/>
   </properties>
  </object>
  <object id="8" name="Light_Bottom_Left" type="VillageObject" gid="447" x="70" y="418" width="40" height="40"/>
  <object id="10" name="Light_Top_Left" type="VillageObject" gid="444" x="70" y="378" width="40" height="40"/>
  <object id="11" name="Light_Bottom_Right" type="VillageObject" gid="447" x="460" y="418" width="40" height="40"/>
  <object id="12" name="Light_Top_Right" type="VillageObject" gid="444" x="460" y="378" width="40" height="40"/>
  <object id="13" name="Throne" type="VillageObject" gid="1098" x="217.5" y="495" width="138" height="93"/>
  <object id="14" name="Lion_Top_Right" type="VillageObject" gid="676" x="346" y="491" width="30" height="30"/>
  <object id="15" name="Lion_Top_Left" type="VillageObject" gid="673" x="194" y="491" width="30" height="30"/>
  <object id="2" name="MainStart" type="PlayerStart" x="270" y="810" width="30" height="30"/>
  <object id="23" name="Emperor" type="NPC" gid="1099" x="270" y="540" width="30" height="50">
   <properties>
    <property name="onstart">this.state = &quot;onwait&quot;;
this.blockable = false;
this.stopCount = 0;
this.minimapColor = &quot;#FF0&quot;;

this.maxDist = Math.sqrt(Math.pow(this.location[4] - 564, 2) + Math.pow(this.location[5] - 182,  2));
this.properties[&quot;currentTask&quot;] = 1;
this.properties.loadBoat = false;
this.properties.rideBoat = false;

this.scale = 1;

this.updateSize = function(width, height){
	var w = Math.floor(width * this.scale);
	var h = Math.floor(height * this.scale);
	
	ArcActor.prototype.updateSize.call(this, w, h);
};

this.enterBoat = function(loadComplete){
	this.onenterboat = function(){
		if(!this.lastStep[2]){
			++this.stopCount;
		}

		if(this.stopCount &gt; 1){
			this.state = &quot;onwait&quot;;
			this.drawEnabled = false;
			this.updateLocation(0, 0);
			loadComplete();
		}
	}

	this.waypoint[0] = this.location[0];
	this.waypoint[1] = 925; 
	this.stopCount = 0;
	this.state = &quot;onenterboat&quot;;
}

this.triggerStoryDialog = function(player, world, worldAdapter){
	var _this = this;

	var taskCompleted = function(){
		switch(_this.properties[&quot;currentTask&quot;]){
			case 1:
				world.getObject(&quot;ThroneEvent&quot;).triggerBanners(this, player, world, worldAdapter);	
				break;
			case 2:
				world.getObject(&quot;ThroneEvent&quot;).triggerMoney(this, player, world, worldAdapter);	
				break;
			case 3:
				world.getObject(&quot;ThroneEvent&quot;).triggerIsland(this, player, world, worldAdapter);	
				break;
			case 4:
				world.getObject(&quot;ThroneEvent&quot;).triggerBoat(this, player, world, worldAdapter);
				break;
			case 5:
				_this.properties[&quot;currentTask&quot;]++;
				world.getObject(&quot;ThroneEvent&quot;).loadBoat(this, player, world, worldAdapter, function(){ _this.triggerStoryDialog(player, world, worldAdapter);  } );
				return;
		}

		_this.properties[&quot;currentTask&quot;]++;
		_this.TriggerDialog('EMPEROR_' + _this.properties[&quot;currentTask&quot;], worldAdapter, player, openTask);
		
	};
	
	var openTask = function(){
		switch(_this.properties[&quot;currentTask&quot;]){
			case 1:
				var sPath = worldAdapter.module.path + &quot;/tasks/strength.png&quot;;
console.log(sPath);
				var t = _this.TriggerTask('PaintBrush2', worldAdapter, function(){
					var t2 = _this.TriggerTask('PaintBrush2', worldAdapter, taskCompleted);
					t2.setBackground(sPath);
					t2.setTitle(&quot;Strength&quot;);
					t2.setBrushSize(0.08, 0.35);
				});
				t.setBackground( worldAdapter.module.path + &quot;/tasks/wealth.png&quot;);
				t.setTitle(&quot;Wealth&quot;);
				t.setBrushSize(0.08, 0.35);	
				break;
			case 2:
				var t = _this.TriggerTask('PaintBrush2', worldAdapter, taskCompleted);
				t.setBackground( worldAdapter.module.path + &quot;/tasks/gold_outline.png&quot;);
				t.setTitle(&quot;Gold&quot;);
				break;
			case 3:
				var t = _this.TriggerTask('PaintBrush2', worldAdapter, taskCompleted);
				t.setBackground( worldAdapter.module.path + &quot;/tasks/island.png&quot;);
				t.setTitle(&quot;Island&quot;);
				break;
			case 4:
				var t = _this.TriggerTask('PaintBrush2', worldAdapter, taskCompleted);
				t.setBackground( worldAdapter.module.path + &quot;/tasks/boat_outline.png&quot;);
				t.setTitle(&quot;Boat&quot;);
				break;
			case 5:
				taskCompleted(_this, player, world, worldAdapter);
				break;
			case 6:
				_this.properties[&quot;currentTask&quot;]++;
				world.getObject('Boat').properties.sinkBoat = true;
				break;
			case 7:
				_this.properties[&quot;currentTask&quot;]++;
				world.getObject('Boat').properties.isSinking = true;
				break;

			case 8:
				_this.properties[&quot;currentTask&quot;]++;
				world.getObject('Cloud').enterStage();
				break;

			case 9:
				_this.properties[&quot;currentTask&quot;]++;
				world.getObject('Cloud').exitStage();
				_this.triggerStoryDialog(player, world, worldAdapter);
				break;

			case 10:
				player.hasControl = true;
				break;
				
		}
	};
	
	this.TriggerDialog('EMPEROR_' + this.properties[&quot;currentTask&quot;], worldAdapter, player, openTask);
}

this.triggerGuards = function(world, worldAdapter, player){
	game.display.camera.target = player.user;

	this.TriggerDialog('ACT_3_BEGIN_2', worldAdapter, player, function(){
		var guard = world.getObject(&quot;Guard 1&quot;);
		guard.properties[&quot;playerSpeed&quot;] = player.speed;
		player.speed = guard.speed;
		guard.InitializePath(&quot;PATH_GUARD_1&quot;);

		guard = world.getObject(&quot;Guard 2&quot;);
		guard.InitializePath(&quot;PATH_GUARD_2&quot;);
		
		player.waypointLoc[0] = 570;
		player.waypointLoc[1] = 1200;
	});
}</property>
    <property name="ontalk" value="this.triggerStoryDialog(player, world, worldAdapter);"/>
    <property name="onwait">if(this.properties.rideBoat){
	this.properties.rideBoat = false;
	world.getObject(&quot;ThroneEvent&quot;).rideBoat(this, player, world, worldAdapter);
}

if(this.properties.loadBoat){
	this.properties.loadBoat = false;
}

</property>
    <property name="spritesheet" value="emperor"/>
   </properties>
  </object>
  <object id="26" name="Main Guard" type="NPC" gid="1099" x="300" y="570" width="30" height="50">
   <properties>
    <property name="onstart">this.enterBoat = function(loadComplete){
	this.onenterboat = function(time, player, world, worldAdapter){
		if(!this.lastStep[2]){
			++this.stopCount;
		}

		if(this.stopCount &gt; 1){
			this.state = &quot;onwait&quot;;
			this.drawEnabled = false;
			loadComplete();
			world.objects.removeChild(&quot;Main Guard&quot;);
		}
	}

	this.waypoint[0] = this.location[0];
	this.waypoint[1] = 925; 
	this.stopCount = 0;
	this.state = &quot;onenterboat&quot;;
}</property>
    <property name="spritesheet" value="imperial_guard"/>
   </properties>
  </object>
  <object id="27" name="PATH_GUARD_1" type="Path" x="307.5" y="780">
   <polyline points="0,0 0,-180 37.5,-180"/>
  </object>
  <object id="29" name="Guard 1" type="NPC" gid="1099" x="292.5" y="810" width="30" height="50">
   <properties>
    <property name="onafterpathupdate">var localPath = this.path;
var path = world.getObject(localPath.name);

if(localPath.point &gt;= path.pointCount){
	this.waypoint[0] = this.location[4];
	this.waypoint[1] = this.location[5];
	this.direction = 1;
	this.updateAnimation();

	this.state = &quot;onwait&quot;;

	player.speed = this.properties[&quot;playerSpeed&quot;];	

	var emperor = world.getObject(&quot;Emperor&quot;);
	emperor.triggerStoryDialog(player, world, worldAdapter);
}</property>
    <property name="onstart">this.enterBoat = function(loadComplete){
	this.onenterboat = function(time, player, world, worldAdapter){
		if(!this.lastStep[2]){
			++this.stopCount;
		}

		if(this.stopCount &gt; 1){
			this.state = &quot;onwait&quot;;
			this.drawEnabled = false;
			loadComplete();
			world.objects.removeChild(&quot;Guard 1&quot;);
		}
	}

	this.waypoint[0] = this.location[0];
	this.waypoint[1] = 925; 
	this.stopCount = 0;
	this.state = &quot;onenterboat&quot;;
}</property>
    <property name="spritesheet" value="imperial_guard"/>
   </properties>
  </object>
  <object id="30" name="Guard 2" type="NPC" gid="1099" x="247.5" y="810" width="30" height="50">
   <properties>
    <property name="onafterpathupdate">var localPath = this.path;
var path = world.getObject(localPath.name);

if(localPath.point &gt;= path.pointCount){
	this.waypoint[0] = this.location[4];
	this.waypoint[1] = this.location[5];
	this.direction = 3;
	this.updateAnimation();
	this.state = &quot;onwait&quot;;	
}</property>
    <property name="onstart">this.enterBoat = function(loadComplete){
	this.onenterboat = function(time, player, world, worldAdapter){
		if(!this.lastStep[2]){
			++this.stopCount;
		}

		if(this.stopCount &gt; 1){
			this.state = &quot;onwait&quot;;
			this.drawEnabled = false;
			loadComplete();
			world.objects.removeChild(&quot;Guard 2&quot;);
		}
	}

	this.waypoint[0] = this.location[0];
	this.waypoint[1] = 925; 
	this.stopCount = 0;
	this.state = &quot;onenterboat&quot;;
}</property>
    <property name="spritesheet" value="imperial_guard"/>
   </properties>
  </object>
  <object id="32" name="PATH_GUARD_2" type="Path" x="262.5" y="780">
   <polyline points="0,0 0,-180 -45,-180"/>
  </object>
  <object id="42" name="Chair 1" type="VillageObject" gid="443" x="360" y="860.5" width="40" height="40"/>
  <object id="43" name="Chair 2" type="VillageObject" gid="443" x="360" y="770.5" width="40" height="40"/>
  <object id="44" name="Chair 3" type="VillageObject" gid="443" x="360" y="680.5" width="40" height="40"/>
  <object id="45" name="Chair 6" type="VillageObject" gid="443" x="170" y="681" width="40" height="40"/>
  <object id="46" name="Chair 5" type="VillageObject" gid="443" x="170" y="771" width="40" height="40"/>
  <object id="47" name="Chair 4" type="VillageObject" gid="443" x="170" y="861" width="40" height="40"/>
  <object id="48" name="Boat" type="VillageObject" gid="1115" x="247.5" y="487.5" width="70" height="112" visible="0">
   <properties>
    <property name="onidle">if(this.properties.isMoving){
	var scale =  Math.sqrt(Math.pow(this.location[4] - 564, 2) + Math.pow(this.location[5] - 240,  2)) / this.properties.maxDist;
	scale = 0.90 * scale + 0.10;

	var speed = 0.08 * scale + 0.02;
	this.location[5] -= (speed * time);

	this.updateSize(140 * scale, 224 * scale); // TODO: grab the initial scale

	if(this.inLocation(564, 240, 564, 240)){
		this.properties.isMoving = false;
		this.properties.atIsland = true;
	}
}else if(this.properties.atIsland &amp;&amp; this.properties.sinkBoat){
	this.properties.sinkBoat = false;
	world.getObject(&quot;Emperor&quot;).triggerStoryDialog(player, world, worldAdapter);
}else if(this.properties.isSinking){
	this.properties.isSinking = false;
	game.display.camera.target = player.user;
	world.getObject(&quot;ThroneEvent&quot;).closePortal(this, player, world, worldAdapter);
	world.getObject(&quot;Emperor&quot;).triggerStoryDialog(player, world, worldAdapter);
}</property>
    <property name="onstart">this.properties.speed = 2.0;
this.properties.isMoving = false;
this.properties.maxDist = Math.sqrt(Math.pow(this.location[4] - 564, 2) + Math.pow(this.location[5] - 240,  2));
this.properties.sinkBoat = false;
this.properties.atIsland = false;
this.properties.isSinking = false;
this.properties.loadCount = 0;
</property>
   </properties>
  </object>
  <object id="49" name="Cloud" type="NPC" gid="1099" x="-18" y="540" width="30" height="50">
   <properties>
    <property name="onenterstage">if(!this.lastStep[2]){
	++this.stopCount;
}

if(this.stopCount &gt; 1){
	this.state = &quot;onwait&quot;;
	world.getObject('Emperor').triggerStoryDialog(player, world, worldAdapter);
}</property>
    <property name="onstart">this.state = &quot;onwait&quot;;
this.blockable = false;
this.drawEnabled = false;
this.stopCount = 0;

this.minimapColor = &quot;#FF0&quot;;

this.properties.targetLocation = [570, 1080];
this.updateLocation(0.0, this.location[5]);

this.enterStage = function(){
	this.drawEnabled = true;
	this.waypoint[0] = this.properties.targetLocation[0];
	this.waypoint[1] = this.properties.targetLocation[1];

	this.state = &quot;onenterstage&quot;;
}

this.exitStage = function(){
	this.waypoint[0] = this.properties.targetLocation[0];
	this.waypoint[1] = 3000.0;
}</property>
    <property name="spritesheet" value="cloud"/>
   </properties>
  </object>
 </objectgroup>
 <objectgroup name="triggers">
  <object id="24" name="StoryTrigger" type="ScriptTrigger" x="240" y="795" width="90" height="45">
   <properties>
    <property name="oninteract">var _this = this;
player.hasControl = false;
player.stats.jailTalkback++;

var emperor = world.getObject(&quot;Emperor&quot;);
game.display.camera.target = emperor;

game.display.camera.addAction(new ArcCameraFadeIn(3000, function(camera){
	world.triggers.removeChild(_this.name);
	world.getObject(&quot;Main Guard&quot;).TriggerDialog(&quot;ACT_3_BEGIN_1&quot;, worldAdapter, player, function(){
		emperor.triggerGuards(world, worldAdapter, player);
	});
}, 0.0, 0.0, 0.0));</property>
    <property name="onstart">this.interactEnabled = true;
game.display.camera.addAction(new ArcCameraFadeOut(1, function(camera){}, 0.0, 0.0, 0.0));</property>
   </properties>
  </object>
  <object id="50" name="LeaveChange1" type="ChangeMapTrigger" x="193" y="811" width="192" height="37.5833">
   <properties>
    <property name="Map" value="game_4_2"/>
    <property name="Start" value="MainStart"/>
    <property name="onstart" value="this.interactEnabled = false;"/>
   </properties>
  </object>
 </objectgroup>
 <layer name="high" width="19" height="28" opacity="0.47">
  <data encoding="csv">
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,5,6,7,8,9,10,11,12,13,0,0,0,0,0,
0,0,0,0,0,31,32,33,34,35,36,37,38,39,0,0,0,0,0,
0,0,0,0,0,57,58,59,60,61,62,63,64,65,0,0,0,0,0,
0,0,0,0,0,83,0,0,0,0,0,0,0,91,0,0,0,0,0,
0,0,0,0,0,109,0,0,0,0,0,0,0,117,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,200,0,0,0,0,0,0,0,0,0,200,0,0,0,0,
0,0,0,0,226,0,0,0,0,0,0,0,0,0,226,0,0,0,0,
0,0,0,0,252,0,203,0,0,0,0,0,203,0,252,0,0,0,0,
0,0,0,0,278,0,0,0,0,0,0,0,0,0,278,0,0,0,0,
0,0,0,0,304,0,0,0,0,0,0,0,0,0,304,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,200,0,0,0,0,0,0,0,0,0,0,0,200,0,0,0,
0,0,0,226,0,0,0,0,0,0,0,0,0,0,0,226,0,0,0,
0,0,0,252,0,0,0,0,0,0,0,0,0,0,0,252,0,0,0,
0,0,0,278,0,0,0,0,0,0,0,0,0,0,0,278,0,0,0,
0,0,0,304,0,0,0,0,0,0,0,0,0,0,0,304,0,0,0
</data>
 </layer>
</map>
