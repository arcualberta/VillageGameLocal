var CONTROL_MOUSE1_DOWN=1,CONTROL_MOUSE1_UP=2,CONTROL_MOUSE1_DRAG=3,CONTROL_KEY_DOWN=4,CONTROL_KEY_UP=5,LEVEL_LOW=1,LEVEL_MED=2,LEVEL_HIGH=3,LEVEL_ULTRA=4;function arcVerticalMergeOutputTiles(t,e){if(null==t||null==e)return 0;if(t.tileSheet==e.tileSheet&&t.x==e.x&&t.width==e.width){if(e.y<t.y&&t.tile.y==e.tile.y+e.tile.height)return e.height+=t.height,e.tile.height+=t.tile.height,t=null,-1;if(e.x>t.x&&e.tile.x==t.tile.x+t.tile.height)return t.height+=e.height,t.tile.height+=e.tile.height,e=null,1}return t.y===e.y?t.x-e.x:t.y-e.y}function arcSortOutputTiles(t,e){return t.y===e.y?t.x-e.x:t.y-e.y}function ArcBaseObject(){return function(t){if(!(this instanceof arguments.callee))return new arguments.callee(arguments);"function"==typeof this.init&&this.init.apply(this,void 0!=t?t.callee?t:arguments:null)}}function arcGenerateFromTiledJSON(t,e,i){var r={tileset:null,layers:[]},n=0,a=t.tilesets[0],o=a.image,c=a.tilewidth,l=a.tileheight,h=Math.ceil(a.imagewidth/c),s=Math.ceil(a.imageheight/l),d=s*h,p=new Array(d);e=e||c,i=i||l;for(var u in a.tiles){n=parseInt(u);if((O=a.tiles[u]).animation){var f=new ArcAnimation;for(var g in O.animation){var A=O.animation[g],y=parseInt(A.tileid),b=Math.floor(y/h),T=y-b*h;b*=c,T*=l,f.addFrame(T,b,h,s,A.duration,!1,!1)}p[n]=new ArcAnimatedTile(f,!0,!1,u)}}for(r.tileset=new ArcTileSheet(a.name,o,p),n=0;n<t.layers.length;++n){var m=t.layers[n];if("tilelayer"===m.type.toLowerCase()){var w=new ArcTileMap(m.name,m.width,m.height);w.setTileSheet(r.tileset,e,i);for(u=0;u<m.data.length;++u)w.data[u]=m.data[u]-1,function(t){if(!(t<0||p[t])){var e=Math.floor(t/h),i=t-e*h;e*=c,i*=l,p[t]=new ArcTile(i,e,c,l,!0,!1,u)}}(m.data[u]-1);r.layers.push(w)}}for(var u in a.tileproperties){var n=parseInt(u),v=a.tileproperties[u],O=p[n];if(O)for(var j in v){var S=v[j];switch(j){case"walkable":O.walkable="true"===S;break;case"deleted":O.deleted="true"===S;break;default:O[j]=S}}}return r}function arcGetPixel(t,e,i,r,n){if(e<0||i<0||e>=r||i>=n||e>=t.width||i>=t.height)return null;var a=e+i*t.width<<2;return[t.data[a+0],t.data[a+1],t.data[a+2],t.data[a+3]]}function arcDistance(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))}function arcScale2(t,e,i,r,n,a){for(var o=i+n,c=r+a,l=r;l<r+a;++l)for(var h=i;h<i+n;++h){getPixel(t,i,r-1,o,c),getPixel(t,i+1,r,o,c),getPixel(t,i-1,r,o,c),getPixel(t,i,r+1,o,c);var s=getPixel(t,i,r,o,c),d=[s,s,s,s],p=[i+r*n<<3,0,0,0];p[1]=p[0]+4,p[2]=p[0]+(n<<3),p[3]=p[2]+4;for(var u=0;u<4;++u)e.data[p[u]+0]=d[u][0],e.data[p[u]+1]=d[u][1],e.data[p[u]+2]=d[u][2],e.data[p[u]+3]=d[u][3]}}function arcUpscaleImage(t,e,i,r){var n=$("<canvas></canvas>")[0];n.width=e.width,n.height=e.height;var a=n.getContext("2d").getImageData(0,0,n.width,n.height),o=$("<canvas></canvas>")[0];o.width=e.width*t,o.height=e.height*t;for(var c=o.getContext("2d").getImageData(0,0,o.width,o.height),l=0;l<e.height;l+=r)for(var h=0;h<e.width;h+=i)switch(t){case 2:return arcScale2(a,c,h,l,i,r);default:return e}return o.getContext("2d").putImageData(c,0,0),o}var recordEvent=function(t,e,i,r){ga&&ga("send","event",t,e,i,r)},sortOutputTiles=function(){function t(t,e,i){let r=t[e],n=t[i];if(null==r)return-1;if(null==n)return 1;if(r.tileSheet==n.tileSheet&&r.y==n.y&&r.height==n.height){if(r.x==n.x+n.width&&r.tile.x==n.tile.x+n.tile.width)return n.width+=r.width,n.tile.width+=r.tile.width,t[e]=null,-1;if(n.x==r.x+r.width&&n.tile.x==r.tile.x+r.tile.width)return r.width+=n.width,r.tile.width+=n.tile.width,t[i]=r,t[e]=null,-1}return r.x-n.x}function e(t,e,r,n){let a,o,c=r-1,l=e;for(a=e;a<c;++a)(o=n(t,a,c))<0&&(i(t,a,l),++l);return i(t,l,c),l}function i(t,e,i){let r=t[e];return t[e]=t[i],t[i]=r,t}function r(t,i,n,a){let o=null;return i<n&&(r(t,i,o=e(t,i,n,a),a),r(t,o+1,n,a)),t}return function(e){return r(e,0,e.length,t),e}}(),ArcArrayBuffer=new ArcBaseObject,createArrayProperty=function(t,e){Object.defineProperty(t,e,{get:function(){return t.data[e]},enumerable:!0,configurable:!0})},swap=function(t,e,i){let r=t[e];t[e]=t[i],t[i]=r},partition=function(t,e,i,r){for(var n=e[r],a=i,o=i;o<r;++o)t(e[o],n)<0&&(swap(e,o,a),++a);return swap(e,r,a),a},quickSort=function(t,e,i,r){if(i<r){var n=partition(t,e,i,r);quickSort(t,e,i,n-1),quickSort(t,e,n+1,r)}};ArcArrayBuffer.prototype.init=function(t=0){this.data=new Array(t),this.length=0},ArcArrayBuffer.prototype.push=function(t){this.length<this.data.length?this.data[this.length]=t:this.data.push(t),createArrayProperty(this,this.length),++this.length},ArcArrayBuffer.prototype.pop=function(){if(this.length>0){--this.length;var t=this.data[this.length];return this.data[this.length]=null,delete this[this.length],t}return null},ArcArrayBuffer.prototype.splice=function(t,e){var i=this.length-e;i<0&&(i=0);for(var r=t;r<i;++r){var n=r+e;n<this.length&&(this.data[r]=this.data[n])}for(var a=i;a<this.length;++a)delete this[a];return this.length=i,this},ArcArrayBuffer.prototype.sort=function(t){quickSort(t,this.data,0,this.length-1)};var ArcFloat32Array=new ArcBaseObject;ArcFloat32Array.prototype=Object.create(ArcArrayBuffer.prototype),ArcFloat32Array.prototype.init=function(t=0){this.data=new Float32Array(t),this.length=0};var ArcScriptObject=new ArcBaseObject;ArcScriptObject.prototype.init=function(t){this.attachObject=t},ArcScriptObject.prototype.AttachFunction=function(t){this.attachObject[t]=this[t]};var ArcEventObject=new ArcBaseObject;ArcEventObject.prototype.init=function(){},ArcEventObject.prototype.inLocation=function(t,e,i,r){return!0},ArcEventObject.prototype.unload=function(){},ArcEventObject.prototype.draw=function(t,e,i,r,n){},ArcEventObject.prototype.tick=function(t){},ArcEventObject.prototype.click=function(t,e){},ArcEventObject.prototype.interact=function(t,e,i,r){},ArcEventObject.prototype.trigger=function(t,e,i,r,n){};var ArcRenderableObject=new ArcBaseObject;ArcRenderableObject.prototype.init=function(t,e){this.children=new ArcArrayBuffer,this.tickEnabled=!!t,this.drawEnabled=!!e,this.clickEnabled=!1,this.interactEnabled=!1,this.name=null,this.location=new Float32Array(6),this.size=new Uint16Array(4)},ArcRenderableObject.prototype.inLocation=function(t,e,i,r){let n=this.location;return!(i<n[0]||t>n[2]||r<n[1]||e>n[3])},ArcRenderableObject.prototype.updateLocation=function(t,e){let i=this.location,r=this.size;i[0]=t-r[2],i[1]=e-r[3],i[2]=i[0]+r[0],i[3]=i[1]+r[1],i[4]=t,i[5]=e},ArcRenderableObject.prototype.updateSize=function(t,e){this.size[0]=t,this.size[1]=e,this.size[2]=t>>1,this.size[3]=e>>1,this.updateLocation(this.location[4],this.location[5])},ArcRenderableObject.prototype.addChild=function(t,e){var i=this.indexOfChild(e);t.name=e,i<0?this.children.push(t):this.children[i]=t},ArcRenderableObject.prototype.indexOfChild=function(t){for(var e=0;e<this.children.length;++e)if(this.children[e].name===t)return e;return-1},ArcRenderableObject.prototype.getChild=function(t){for(var e=0;e<this.children.length;++e)if(this.children[e].name===t)return this.children[e];return null},ArcRenderableObject.prototype.removeChild=function(t){var e=this.indexOfChild(t);e>0&&(this.children[e].unload(),this.children.splice(e,1))},ArcRenderableObject.prototype.unload=function(){for(var t=0;t<this.children.length;++t){let e=this.children[t];e.drawEnabled&&e.unload()}},ArcRenderableObject.prototype.draw=function(t,e,i,r,n){let a,o;for(o=0;o<this.children.length;++o)(a=this.children[o]).drawEnabled&&a.draw(t,e,i,r,n)},ArcRenderableObject.prototype.tick=function(t){let e,i;for(i=0;i<this.children.length;++i)(e=this.children[i]).tickEnabled&&e.tick.apply(e,arguments)},ArcRenderableObject.prototype.click=function(t,e){let i,r;for(r=0;r<this.children.length;++r)(i=this.children[r]).clickEnabled&&i.click.apply(i,arguments)},ArcRenderableObject.prototype.interact=function(t,e,i,r){let n,a;for(a=0;a<this.children.length;++a)(n=this.children[a]).interactEnabled&&n.interact.apply(n,arguments)};var ArcRenderableObjectCollection=ArcBaseObject();ArcRenderableObjectCollection.prototype=Object.create(ArcRenderableObject.prototype),ArcRenderableObjectCollection.prototype.init=function(t,e){ArcRenderableObject.prototype.init.call(this,t,e)},ArcRenderableObjectCollection.prototype.sort=function(t){this.children.sort(t)},ArcRenderableObjectCollection.prototype.drawWhile=function(t){let e=null,i=0;for(;i<this.children.length&&t(e=this.children[i]);)++i;return e(i-1)};var ArcRenderableText=ArcBaseObject();ArcRenderableText.prototype=Object.create(ArcRenderableObject.prototype),ArcRenderableText.prototype.init=function(t,e){ArcRenderableObject.prototype.init.call(this,!1,!0),this.text=t,this.fontInfo=e,this.offset=[0,0]},ArcRenderableText.prototype.draw=function(t,e,i,r,n){t.drawMessage(this.text,e+this.offset[0],i+this.offset[1],this.fontInfo)};var ArcWaypoint=ArcBaseObject();ArcWaypoint.prototype=Object.create(ArcRenderableObject.prototype),ArcWaypoint.prototype.init=function(){ArcRenderableObject.prototype.init.call(this,!1,!0),this.isVisible=!1},ArcWaypoint.prototype.draw=function(t,e,i,r,n){this.isVisible&&t.drawWaypoint(this.location)};var ArcActor=ArcBaseObject();ArcActor.prototype=Object.create(ArcRenderableObject.prototype),ArcActor.prototype.init=function(t,e,i){ArcRenderableObject.prototype.init.call(this,t,e),this.tickEnabled=!!t,this.drawEnabled=!!e,this.interactRad=8,this.dynamicInteract=!0,this.movementVector=new Float32Array(3)},ArcActor.prototype.setMovementVector=function(t,e){let i=Math.sqrt(t*t+e*e);i>0?(this.movementVector[0]=t/i,this.movementVector[1]=e/i,this.movementVector[2]=Math.atan2(this.movementVector[1],this.movementVector[0])):(this.movementVector[0]=0,this.movementVector[1]=0)},ArcActor.MovementAngle={QUARTER:Math.PI/4,HALF:Math.PI/2,THREE_QUARTER:3*Math.PI/4},ArcActor.prototype.updateSize=function(t,e){if(ArcRenderableObject.prototype.updateSize.apply(this,arguments),this.dynamicInteract){let t=this.size[2],e=this.size[3];this.interactRad=Math.sqrt(t*t+e*e)}};var ArcCharacter=ArcBaseObject();ArcCharacter.prototype=Object.create(ArcActor.prototype),ArcCharacter.prototype.init=function(){ArcActor.prototype.init.call(this,!0,!0),this.animation="stand_down",this.frame=0,this.frameTime=0,this.spriteSheet=null,this.lastCollisionBox=[0,0,0,0]},ArcCharacter.prototype.inLocation=function(t,e,i,r){var n=this.location[4],a=this.location[5];return n>i&&(n=i),n<t&&(n=t),a>r&&(a=r),a<e&&(a=e),n-=this.location[4],a-=this.location[5],Math.sqrt(n*n+a*a)<this.interactRad},ArcCharacter.prototype.updateSize=function(t,e){t==this.size[0]&&e==this.size[1]||ArcActor.prototype.updateSize.call(this,t,e)},ArcCharacter.prototype.collisionBox=function(){var t=this.lastCollisionBox;return t[0]=this.location[0]+2,t[1]=this.location[1]+this.size[3],t[2]=this.size[0]-4,t[3]=this.size[3],t},ArcCharacter.prototype.animateFrame=function(t){let e=this.spriteSheet.getAnimation(this.animation).frames,i=e[this.frame];for(this.frameTime+=t;this.frameTime>i.frameTime;)++this.frame,this.frame>=e.length&&(this.frame=0),this.frameTime-=this.frameTime,i=e[this.frame];i&&this.updateSize(i.drawWidth,i.drawHeight)},ArcCharacter.prototype.setAnimation=function(t){this.animation!==t&&(this.animation=t,this.frame=0,this.frameTime=0)},ArcCharacter.prototype.draw=function(t,e,i,r,n){var a=t.spriteSheets[this.spriteSheet.id],o=a.getAnimation(this.animation).frames[this.frame];t.drawImage(a.image,o.x,o.y,o.width,o.height,this.location[0],this.location[1],o.drawWidth,o.drawHeight)},ArcCharacter.prototype.tick=function(t){this.animateFrame(t),ArcActor.prototype.tick.apply(this,arguments)};var QuadTree=ArcBaseObject(),treeTick=function(t){t.tick.apply(t,treeTick.args)};treeTick.args=null;var treeClick=function(t){t.clickEnabled&&t.inLocation(treeClick.x,treeClick.y,treeClick.x,treeClick.y)&&t.click.apply(t,treeClick.args)};treeClick.args=null,treeClick.x=0,treeClick.y=0;var treeInteract=function(t){t.interactEnabled&&t.inLocation(treeInteract.left,treeInteract.top,treeInteract.right,treeInteract.bottom)&&t.interact.apply(t,treeInteract.args)};treeInteract.args=null,treeInteract.left=0,treeInteract.top=0,treeInteract.right=0,treeInteract.bottom=0;var quadSort=function(t,e){return t.location[3]-e.location[3]};QuadTree.prototype=Object.create(ArcRenderableObject.prototype),QuadTree.prototype.init=function(t,e,i,r,n){ArcRenderableObject.prototype.init.call(this,!0,!0),this.tickEnabled=!0,this.drawEnabled=!0,this.clickEnabled=!0,this.interactEnabled=!0,this.level=n||0,this.halfSize=[i/2,r/2],this.nodes=[null,null,null,null],this.childrenCount=0,this.updateSize(i,r),this.updateLocation(t,e)},QuadTree.prototype.updateLocation=function(t,e){this.location[0]=t,this.location[1]=e,this.location[2]=t+this.size[0],this.location[3]=e+this.size[1],this.location[4]=t+this.size[2],this.location[5]=e+this.size[3]},QuadTree.prototype.unload=function(){this.clear()},QuadTree.prototype.clear=function(t){var e=0,i=this.nodes;if(t)for(e=0;e<this.children.length;++e)t(this.children[e]);for(this.children.length=0,e=0;e<4;++e)null!==i[e]&&(i[e].clear(),i[e]=null)},QuadTree.prototype.split=function(){var t=this.halfSize[0],e=this.halfSize[1],i=this.location[0],r=this.location[1],n=this.level+1;this.nodes[0]=new QuadTree(i+t,r,t,e,n),this.nodes[1]=new QuadTree(i,r,t,e,n),this.nodes[2]=new QuadTree(i,r+e,t,e,n),this.nodes[3]=new QuadTree(i+t,r+e,t,e,n)},QuadTree.prototype.getIndex=function(t,e,i,r){let n=this.location,a=n[0]+this.size[2],o=n[1]+this.size[3],c=e+r<o,l=e>=o;return t+i<a?c?1:l?2:-2:t>=a?c?0:l?3:-3:c?-4:l?-5:-1},QuadTree.prototype.isInside=function(t){return t.inLocation(this.location[0],this.location[1],this.location[3],this.location[4])},QuadTree.prototype.getChild=function(t){let e,i,r=null;if(this.children.length>0)for(e=this.children.length-1;e>=0;--e)if((r=this.children[e]).name==t)return r;if(null!==(i=this.nodes)[0])for(e=0;e<4;++e)if(null!==(r=i[e].getChild(t)))return r;return null},QuadTree.prototype.removeChild=function(t){let e,i,r=null;if(this.children.length>0)for(e=this.children.length-1;e>=0;--e)if((r=this.children[e]).name==t)return r.unload(),this.children.splice(e,1),r;if(null!==(i=this.nodes)[0])for(e=0;e<4;++e)if(null!==(r=i[e].removeChild(t)))return r;return null},QuadTree.prototype.recalculate=function(t){let e,i=this.nodes,r=!0,n=!1;var a;if(null!==i[0]&&(r=i[0].recalculate(t),r=i[1].recalculate(t)&&r,r=i[2].recalculate(t)&&r,(r=i[3].recalculate(t)&&r)&&(i[0]=null,i[1]=null,i[2]=null,i[3]=null)),this.children.length>0)for(e=this.children.length-1;e>=0;--e)a=this.children[e],this.isInside(a)||(t.push(a),this.children.splice(e,1),n=!0);if(!n&&t.length>0)for(e=t.length-1;e>=0;--e){if(a=t.pop(),!this.isInside(a)){t.push(a);break}this.insert(a)}return null===i[0]&&this.children.length<1},QuadTree.prototype.insert=function(t){var e=this.nodes;if(null!==e[0]&&(n=this.getIndex(t.location[0],t.location[1],t.size[0],t.size[1]))>-1)e[n].insert(t);else if(this.children.push(t),this.children.length>QuadTree.MAX_OBJECTS&&this.level<QuadTree.MAX_LEVELS){null===this.nodes[0]&&this.split();for(var i=0;i<this.children.length;){var r=this.children[i],n=this.getIndex(r.location[0],r.location[1],r.size[0],r.size[1]);n>-1?(this.children.splice(i,1),this.nodes[n].insert(r)):++i}}},QuadTree.prototype.getObjects=function(t,e,i,r,n,a){if(this.inLocation(t,e,t+i,e+i)){for(var o=0;o<this.children.length;++o)n&&n.push(this.children[o]),a&&a(this.children[o]);var c=this.nodes;if(null!==c[0]){var l=this.getIndex(t,e,i,r);l>=0?c[l].getObjects(t,e,i,r,n,a):-2==l?(c[1].getObjects(t,e,i,r,n,a),c[2].getObjects(t,e,i,r,n,a)):-3==l?(c[0].getObjects(t,e,i,r,n,a),c[3].getObjects(t,e,i,r,n,a)):-4==l?(c[1].getObjects(t,e,i,r,n,a),c[0].getObjects(t,e,i,r,n,a)):-5==l?(c[3].getObjects(t,e,i,r,n,a),c[2].getObjects(t,e,i,r,n,a)):(c[0].getObjects(t,e,i,r,n,a),c[1].getObjects(t,e,i,r,n,a),c[2].getObjects(t,e,i,r,n,a),c[3].getObjects(t,e,i,r,n,a))}}return n},QuadTree.prototype.getByName=function(t){return this.getChild(t)},QuadTree.prototype.tick=function(t){if(treeTick.args=arguments,this.getObjects(this.location[0],this.location[1],this.size[0],this.size[1],!1,treeTick),0==this.level){let t=QuadTree.ArrayBuffer;for(t.length=0,this.recalculate(t),index=0;index<t.length;++index)this.insert(t[index])}},QuadTree.prototype.drawGrid=function(t,e,i,r,n){let a=this.location[0],o=this.location[1],c=this.location[2],l=this.location[3];t.drawLine(a,o,a,l,"#00F"),t.drawLine(a,o,c,o,"#00F"),t.drawLine(c,l,a,l,"#00F"),t.drawLine(c,l,c,o,"#00F");let h=this.nodes;if(null!==h[0]){let a=this.getIndex(e,i,r,n);a>-1?h[a].drawGrid(t,e,i,r,n):(h[0].drawGrid(t,e,i,r,n),h[1].drawGrid(t,e,i,r,n),h[2].drawGrid(t,e,i,r,n),h[3].drawGrid(t,e,i,r,n))}},QuadTree.prototype.draw=function(t,e,i,r,n){let a,o=QuadTree.ArrayBuffer;for(o.length=0,this.getObjects(e,i,r,n,o),o.sort(quadSort),a=0;a<o.length;++a)o[a].drawEnabled&&o[a].draw(t,e,i,r,n);window.debugMode&&this.drawGrid(t,e,i,r,n)},QuadTree.prototype.click=function(t,e){treeClick.args=arguments,treeClick.x=t,treeClick.y=e,this.getObjects(t,e,1,1,!1,treeClick)},QuadTree.prototype.interact=function(t,e,i,r){treeInteract.args=arguments,treeInteract.left=t,treeInteract.right=i,treeInteract.top=e,treeInteract.bottom=r,this.getObjects(t,e,i,r,!1,treeInteract)},QuadTree.ArrayBuffer=new ArcArrayBuffer,QuadTree.StackBuffer=new ArcArrayBuffer,QuadTree.MAX_OBJECTS=5,QuadTree.MAX_LEVELS=10,QuadTree.setMemoryLevel=function(t){switch(t){case LEVEL_LOW:QuadTree.MAX_OBJECTS=3,QuadTree.MAX_LEVELS=5;break;case LEVEL_MED:QuadTree.MAX_OBJECTS=5,QuadTree.MAX_LEVELS=10;break;case LEVEL_HIGH:QuadTree.MAX_OBJECTS=5,QuadTree.MAX_LEVELS=15;break;case LEVEL_ULTRA:QuadTree.MAX_OBJECTS=10,QuadTree.MAX_LEVELS=15}};var ArcTileQuadTree_Tile=ArcBaseObject();ArcTileQuadTree_Tile.prototype=Object.create(ArcRenderableObject()),ArcTileQuadTree_Tile.prototype.init=function(t,e,i,r,n){ArcRenderableObject.prototype.init.call(this,!1,!1),this.location[4]=e+(r>>1),this.location[5]=i+(r>>1),this.updateSize(r,n),this.tile=t},ArcTileQuadTree_Tile.prototype.isBlocked=function(t,e,i,r,n,a){return this.inLocation(t,e,i,r)?!this.tile.walkable:null},ArcTileQuadTree_Tile.prototype.trigger=function(t,e,i,r,n){let a="on"+t;this.tile.properties[a]&&this.inLocation(e,i,r,n)&&this.tile.properties[a](this)};var ArcTileQuadTree=ArcBaseObject(),tileTrigger=function(t){t.trigger(tileTrigger.action,tileTrigger.left,tileTrigger.top,tileTrigger.right,tileTrigger.bottom)};tileTrigger.action=null,tileTrigger.left=0,tileTrigger.right=0,tileTrigger.top=0,tileTrigger.bottom=0;var tileDraw=function(t){t.tile.isDrawable&&tileDraw.buffer.push(t)};tileDraw.buffer=null,ArcTileQuadTree.prototype=Object.create(QuadTree.prototype),ArcTileQuadTree.prototype.init=function(t,e,i,r,n,a){QuadTree.prototype.init.call(this,t,e,i,r,n),this.scroll=a?[a[0],a[1]]:null,this.offset=[0,0],this.repeat=a&&null!==a&&(0!==a[0]||0!==a[1]),this.searchStack=[]},ArcTileQuadTree.prototype.MIN_WIDTH=128,ArcTileQuadTree.prototype.MIN_HEIGHT=128,ArcTileQuadTree.prototype.SPLIT_CHECK={isSplit:!1,xSplits:[],ySplits:[]},ArcTileQuadTree.prototype.split=function(){var t=this.halfSize[0],e=this.halfSize[1],i=this.location[0],r=this.location[1],n=this.level+1;if(this.nodes[0]=new ArcTileQuadTree(i+t,r,t,e,n),this.nodes[1]=new ArcTileQuadTree(i,r,t,e,n),this.nodes[2]=new ArcTileQuadTree(i,r+e,t,e,n),this.nodes[3]=new ArcTileQuadTree(i+t,r+e,t,e,n),t>this.MIN_WIDTH&&e>this.MIN_HEIGHT)for(var a=0;a<4;++a)this.nodes[a].split()},ArcTileQuadTree.prototype.insertTile=function(t,e,i,r,n){var a=new ArcTileQuadTree_Tile(t,e,i,r,n);return this.insert(a),a},ArcTileQuadTree.prototype.insert=function(t){var e=this.nodes;if(null!==e[0]){var i=this.getIndex(t.location[0],t.location[1],t.size[0],t.size[1]);if(i>-1)return void e[i].insert(t)}this.children.push(t)},ArcTileQuadTree.prototype.calculateDrawSplit=function(t,e,i,r,n,a){},ArcTileQuadTree.prototype.trigger=function(t,e,i,r,n){tileTrigger.action=t,tileTrigger.left=e,tileTrigger.right=r,tileTrigger.top=i,tileTrigger.bottom=n,this.getObjects(e,i,r-e,n-i,!1,tileTrigger)},ArcTileQuadTree.prototype.isBlocked=function(t,e,i,r,n,a){const o=this.nodes;let c,l,h,s=null;for(c=0;c<this.children.length;++c)if(h=this.children[c],null!==(l=h.isBlocked(t,e,i,r,n,a))){if(l)return!0;s=!1}if(null!==o[0])if((c=this.getIndex(t,e,n,a))>-1){if(null!==(l=o[c].isBlocked(t,e,i,r,n,a))){if(l)return!0;s=!1}}else for(c=0;c<4;++c)if(null!==(l=o[c].isBlocked(t,e,i,r,n,a))){if(l)return!0;s=!1}return s},ArcTileQuadTree.prototype.tick=function(t){if(null!==this.scroll){let e=this.size[0],i=this.size[1],r=this.offset,n=t/1e3;for(r[0]+=n*this.scroll[0],r[1]+=n*this.scroll[1];r[0]<-e;)r[0]+=e;for(;r[0]>e;)r[0]-=e;for(;r[1]<-i;)r[1]+=i;for(;r[1]>i;)r[1]-=i}},ArcTileQuadTree.prototype.drawGrid=function(t,e,i,r,n){let a="rgba(128, 0, 128, 0.1)",o=this.location[0],c=this.location[1],l=this.location[2],h=this.location[3];t.drawLine(o,c,o,h,a),t.drawLine(o,c,l,c,a),t.drawLine(l,h,o,h,a),t.drawLine(l,h,l,c,a);let s=this.nodes;if(null!==s[0]){let a=this.getIndex(e,i,r,n);a>-1?s[a].drawGrid(t,e,i,r,n):(s[0].drawGrid(t,e,i,r,n),s[1].drawGrid(t,e,i,r,n),s[2].drawGrid(t,e,i,r,n),s[3].drawGrid(t,e,i,r,n))}},ArcTileQuadTree.prototype.draw=function(t,e,i,r,n){let a=QuadTree.ArrayBuffer;a.length=0,tileDraw.buffer=a,this.getObjects(e,i,r,n,!1,tileDraw),a.sort(arcSortOutputTiles),t.drawTileLayer(a),window.debugMode&&this.drawGrid(t,e,i,r,n)};var ArcSound=ArcBaseObject();ArcSound.prototype.init=function(t,e,i){this.name=t,this.loop=e,this.volume=1,this.url=i,this.source=null,this.gain=null,this.state=0};var ArcAnimation=ArcBaseObject();ArcAnimation.prototype.init=function(){this.frames=[],this.length=this.frames.length},ArcAnimation.prototype.addFrame=function(t,e,i,r,n,a,o,c,l){this.frames.push({x:t,y:e,width:i,height:r,wHalf:c?c>>1:i,hHalf:l?l>>1:r,drawWidth:c||i<<1,drawHeight:l||r<<1,frameTime:n,flipX:a,flipY:o}),this.length=this.frames.length};var ArcSpriteSheet=ArcBaseObject();ArcSpriteSheet.prototype.init=function(t,e,i){var r=this;this.id=null,this.baseImage=t?new Image:null,this.image=null,this.animations={},this.palette=i||{},this.onImageUpdate=e,t&&(this.baseImage.onload=function(){var t=[r.baseImage.width,r.baseImage.height];r.image=$("<canvas></canvas>")[0],r.image.width=t[0],r.image.height=t[1],r.dimension=t,r.context=r.image.getContext("2d"),r.updateColorset(),r.image.complete=!0},this.baseImage.src=t)},ArcSpriteSheet.prototype.copy=function(){var t=new ArcSpriteSheet(this.baseImage.src,!1,JSON.parse(JSON.stringify(this.palette)));return t.id=this.id,t.animations=this.animations,t},ArcSpriteSheet.prototype.setPalette=function(t){this.palette=t},ArcSpriteSheet.prototype.setAnimation=function(t,e){this.animations[t]=e},ArcSpriteSheet.prototype.getAnimation=function(t){return this.animations[t]},ArcSpriteSheet.prototype.getSimpleAnimations=function(){var t={};for(var e in this.animations){var i={frames:this.getAnimation(e).frames};t[e]=i}return t},ArcSpriteSheet.prototype.getSimple=function(){return{id:this.id,image:this.baseImage.src,animations:this.getSimpleAnimations(),palette:this.palette}},ArcSpriteSheet.prototype.updateColorset=function(){var t=this.baseImage;if(null!==t){var e=this.context;e.drawImage(t,0,0);for(var i=e.getImageData(0,0,this.dimension[0],this.dimension[1]),r=i.data,n=0;n<r.length;n+=4){var a=r[n+0];a=((a=(a<<8)+r[n+1])<<8)+r[n+2];var o=this.palette[a];o&&(r[n+0]=o.r,r[n+1]=o.g,r[n+2]=o.b)}e.putImageData(i,0,0),this.onImageUpdate&&this.onImageUpdate(this)}};var ArcTileSheet=ArcBaseObject();ArcTileSheet.prototype.init=function(t,e,i,r,n,a,o,c,l,h){var s=this;this.image=c?null:new Image,this.imageUrl=e,this.tiles=i,this.name=t,this.firstGid=n||0,this.tileWidth=a,this.tileHeight=o,this.imageWidth=l,this.imageHeight=h,c||(r&&(this.image.onload=function(){this.imageWidth=s.image.width,this.imageHeight=s.image.height,r(s)}),this.image.src=e)},ArcTileSheet.prototype.update=function(t){for(var e=0;e<this.tiles.length;++e){var i=this.tiles[e];i&&null!==i&&i.update(t),this.imageLoadFunc&&this.imageLoadFunc(this)}};var ArcTile=ArcBaseObject();ArcTile.prototype.init=function(t,e,i,r,n,a,o){this.x=t,this.y=e,this.width=i,this.height=r,this.walkable=n,this.deleted=a,this.name=o,this.tileSheetName="",this.isDrawable=!0,this.properties={}},ArcTile.prototype.drawable=function(){return this},ArcTile.prototype.update=function(t){},ArcTile.prototype.getState=function(){return this};var ArcAnimatedTile=ArcBaseObject();ArcAnimatedTile.prototype.init=function(t,e,i,r){this.animation=t,this.frame=0,this.frameTime=0,this.walkable=e,this.deleted=i,this.name=r,this.tileSheetName="",this.isDrawable=!0,this.properties={}},ArcAnimatedTile.prototype.update=function(t){var e=this.animation.frames[this.frame];for(this.frameTime+=t;this.frameTime>e.frameTime;)++this.frame,this.frame>=this.animation.length&&(this.frame=0),this.frameTime-=e.frameTime},ArcAnimatedTile.prototype.getState=function(){return this.animation.frames[this.frame]},ArcAnimatedTile.prototype.drawable=function(){return this.getState()};var ArcTileMap=new ArcBaseObject;ArcTileMap.prototype=Object.create(ArcRenderableObject.prototype),ArcTileMap.prototype.init=function(t,e,i,r,n,a,o){this.tickEnabled=!0,this.drawEnabled=!0,this.dimension=new Uint16Array([e,i]),this.tileSheets=null,this.tileDimension=new Uint8Array([r,n]),this.name=t;var c=[0,0];a&&null!==a&&(c[0]=a),o&&null!==o&&(c[1]=o),this.data=new ArcTileQuadTree(0,0,e*r,i*n,0,c),this.data.split()},ArcTileMap.prototype.setTile=function(t,e,i,r,n){return this.data.insertTile(t,e,i,r,n)},ArcTileMap.prototype.setTileSheet=function(t,e,i){this.tileSheets=t,this.tileDimension[0]=e,this.tileDimension[1]=i},ArcTileMap.prototype.getClosestTileCoord=function(t,e,i){i[0]=Math.round(t/this.tileWidth),i[1]=Math.round(e/this.tileHeight)},ArcTileMap.prototype.getTile=function(t,e){var i=e*this.dimension[0]*t,r=this.data[i];return r>=0?this.tileSheet[r]:null},ArcTileMap.prototype.isBlocked=function(t,e,i,r,n,a){return this.data.isBlocked(t,e,i,r,n,a)},ArcTileMap.prototype.draw=function(t,e,i,r,n){this.data.draw(t,e,i,r,n)},ArcTileMap.prototype.tick=function(t){this.data&&this.data.tick.apply(this.data,arguments)},ArcTileMap.prototype.trigger=function(t,e,i,r,n){this.data&&this.data.trigger(t,e,i,r,n)};var ArcMap=ArcBaseObject();ArcMap.prototype=Object.create(ArcRenderableObject.prototype),ArcMap.prototype.init=function(t,e){ArcRenderableObject.prototype.init.call(this,!0,!0),this.parent=t,this.name=e,this.tileSheets={},this.width=100,this.height=100,this.tileWidth=16,this.tileHeight=16,this.tiles=[],this.loaded=!1},ArcMap.prototype.unload=function(){this.loaded=!1,ArcRenderableObject.prototype.unload.call(this),this.tiles.length=0},ArcMap.prototype.getTileSheetForTile=function(t){var e=null;for(var i in this.tileSheets){var r=this.tileSheets[i];r.firstGid<=t&&(null==e||e.firstGid<r.firstGid)&&(e=r)}return e};var ArcTrigger=ArcBaseObject();ArcTrigger.prototype=Object.create(ArcEventObject.prototype),ArcTrigger.prototype.init=function(t,e,i,r,n){this.name=t,this.location=new Float32Array([i[0],i[1],i[0]+r[0],i[1]+r[1]]),this.centre=new Float32Array([i[0]+r[0]/2,i[1]+r[1]/2]),this.size=r.slice(),this.rotation=n,this.type=e,this.followObject=null,this.interactEnabled=!0},ArcTrigger.prototype.setProperty=function(t,e){this.properties[t]=e},ArcTrigger.prototype.update=function(t,e){"string"==typeof this.followObject&&console.log(this.followObject)},ArcTrigger.prototype.inLocation=function(t,e,i,r){let n=this.location;return!(i<n[0]||t>n[2]||r<n[1]||e>n[3])},ArcTrigger.prototype.interact=function(t,e,i,r,n,a,o){};var ArcSif=ArcBaseObject(),blurImage=function(i,n,r,t,o){var a,f,e=0,s=0,u=o-1;for(a=0;a<o;++a)for(f=0;f<t;++f)s=i[e],s+=a>0?i[e-t]:i[e],s+=a<u?i[e+t]:i[e],n[e]=Math.round(s/3),++e;for(e=0,u=t-1,a=0;a<o;++a)for(f=0;f<t;++f)s=n[e],s+=f>0?n[e-1]:n[e],s+=f<u?n[e+1]:n[e],r[e]=Math.round(s/3),++e},isPoint=function(i,n,r,t,o){for(var a,f=!0,e=!0,s=i,u=n>0?n-1:n,c=n<t-1?n+1:n,l=r>0?r-1:r,h=r<o-1?r+1:r,v=l;v<h;++v)for(var p=u;p<c;++p)if(!(p==n&&v==r||(a=i[v*t+p],f=f&&a<s,e=e&&a>s,f||e)))return!1;return e||f},findPoints=function(i,n,r,t){for(var o=0;o<r;++o)for(var a=0;a<n;++a)isPoint(i,a,o,n,r)&&(t.push(a),t.push(o))},evaluatePoints=function(i,n,r,t){var o,a,f=t.length-1;if(f>0)for(;f<t.length;)a=t[f],o=t[--f],isPoint(i,o,a,n,r)||t.splice(f,2),--f},initialize=function(i,n,r){for(var t=n*r,o=new Uint8Array(t),a=new Uint8Array(t),f=0;f<t;++f)o[f]=i[f<<1];for(blurImage(o,a,o,n,r),findPoints(o,n,r,this.points),f=0;f<2;++f)blurImage(o,a,o,n,r),evaluatePoints(o,n,r,this.points)};ArcSif.prototype.init=function(i,n,r){this.points=[],initialize.call(this,i,n,r)};function arcGetDialogAdapter(t){return window.openDatabase?new ArcSQLDialog(t):new ArcDialog(t)}var ArcDialog=ArcBaseObject();ArcDialog.prototype.init=function(t){var n=this;this.data={},this.loaded=!1,this.getId=function(t,n){return"_"+t+"__"+n},$.ajax({url:t,method:"GET",async:!1,success:function(t){for(var e=t.split("\n"),E=1;E<e.length;++E){var l=$.csv.toArray(e[E]);l.length>12&&n.insert(l[0],parseInt(l[1]),l[2],l[3],l[4],l[5],0===l[6].length?null:parseInt(l[6]),0===l[7].length?null:l[7],0===l[8].length?null:parseInt(l[8]),0===l[9].length?null:l[9],0===l[10].length?null:parseInt(l[10]),0===l[11].length?null:l[11],0===l[12].length?null:parseInt(l[12]))}n.loaded=!0}})},ArcDialog.prototype.insert=function(t,n,e,E,l,N,r,O,a,o,I,i,_){var c=this.getId(t,n);this.data[c]={NAME:t,LINE_NUMBER:n,CHARACTER:e,MESSAGE:E,ON_OPEN:l,ON_CLOSE:N,NEXT_LINE:r,OPTION_1:O,OPTION_1_LINE:a,OPTION_2:o,OPTION_2_LINE:I,OPTION_3:i,OPTION_3_LINE:_}},ArcDialog.prototype.getDialog=function(t,n,e){var E=this.data[this.getId(t,n)];E&&null!=E&&e(E)};var ArcSQLDialog=ArcBaseObject();{function insertSingleEntry(t,n,e,E,l,N,r,O,a,o,I,i,_,c){t.executeSql("SELECT * FROM DIALOGS WHERE NAME = ? AND LINE_NUMBER = ?",[n,e],function(t,s){s.rows.length>0?t.executeSql("UPDATE DIALOGS SET CHARACTER = ?, MESSAGE = ?, ON_OPEN = ?, ON_CLOSE = ?, NEXT_LINE = ?, OPTION_1 = ?, OPTION_1_LINE = ?, OPTION_2 = ?, OPTION_2_LINE = ?, OPTION_3 = ?, OPTION_3_LINE = ? WHERE NAME = ? AND LINE_NUMBER = ?",[E,l,N,r,O,a,o,I,i,_,c,n,e]):t.executeSql("INSERT INTO DIALOGS(NAME, LINE_NUMBER, CHARACTER, MESSAGE, ON_OPEN, ON_CLOSE, NEXT_LINE, OPTION_1, OPTION_1_LINE, OPTION_2, OPTION_2_LINE, OPTION_3, OPTION_3_LINE) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[n,e,E,l,N,r,O,a,o,I,i,_,c])},null)}ArcSQLDialog.prototype=Object.create(ArcDialog.prototype),ArcSQLDialog.prototype.init=function(t,n){var e=this;e.loaded=!1,this.db=openDatabase("arc_db1","1.0","Databse to store needed ARC information.",2097152),this.db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS DIALOGS (NAME, LINE_NUMBER, CHARACTER, MESSAGE, ON_OPEN, ON_CLOSE, NEXT_LINE, OPTION_1, OPTION_1_LINE, OPTION_2, OPTION_2_LINE, OPTION_3, OPTION_3_LINE, PRIMARY KEY (NAME, LINE_NUMBER))")}),$.ajax({url:t,method:"GET",async:!1,success:function(t){var n=t.split("\n");e.db.transaction(function(t){for(var E=1;E<n.length;++E){var l=$.csv.toArray(n[E]);l.length>12&&insertSingleEntry(t,l[0],parseInt(l[1]),l[2],l[3],l[4],l[5],0===l[6].length?null:parseInt(l[6]),0===l[7].length?null:l[7],0===l[8].length?null:parseInt(l[8]),0===l[9].length?null:l[9],0===l[10].length?null:parseInt(l[10]),0===l[11].length?null:l[11],0===l[12].length?null:parseInt(l[12]))}e.loaded=!0})}})},ArcSQLDialog.prototype.insert=function(t,n,e,E,l,N,r,O,a,o,I,i,_){this.db.transaction(function(c){insertSingleEntry(c,t,n,e,E,l,N,r,O,a,o,I,i,_)})},ArcSQLDialog.prototype.getDialog=function(t,n,e){this.db.readTransaction(function(E){n&&null!==n?E.executeSql("SELECT * FROM DIALOGS WHERE NAME = ? AND LINE_NUMBER = ?",[t,n],function(t,n){n.rows.length>0&&e(n.rows.item(0))}):E.executeSql("SELECT * FROM DIALOGS WHERE NAME = ? ORDER BY LINE_NUMBER",[t],function(t,n){n.rows.length>0&&e(n.rows.item(0))})})}}function arcGetDisplayAdapter(e,t){var r,a=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?[ArcGL2CanvasAdapter,ArcGLCanvasAdapter,ArcCanvasAdapter]:[ArcCanvasAdapter];if(t)for(var a=[ArcGL2CanvasAdapter,ArcGLCanvasAdapter,ArcCanvasAdapter],i=0;i<a.length;++i)try{r=new a[i](e);break}catch(e){console.log(e)}else r=new ArcCanvasAdapter(e);return r}var ArcCameraAction=ArcBaseObject();ArcCameraAction.prototype.init=function(e,t){this.timeLimit=e,this.timeComplete=0,this.complete=!1,this.onComplete=t},ArcCameraAction.prototype.update=function(e,t){this.timeComplete+=t,this.timeComplete>=this.timeLimit&&(this.complete=!0,this.onComplete&&this.onComplete(e))};var ArcCameraPanAction=ArcBaseObject();ArcCameraPanAction.prototype=Object.create(ArcCameraAction.prototype),ArcCameraPanAction.prototype.init=function(e,t,r,a,i,o){ArcCameraAction.prototype.init.call(this,e,t),this.velocity=new Float32Array([(i-r)/e,(o-a)/e]),this.location=new Float32Array([r,a])},ArcCameraPanAction.prototype.update=function(e,t){ArcCameraAction.prototype.update.call(this,e,t),this.location[0]+=t*this.velocity[0],this.location[1]+=t*this.velocity[1],e.setOffset(this.location[0],this.location[1])};var ArcCameraMosaic=ArcBaseObject();ArcCameraMosaic.prototype=Object.create(ArcCameraAction.prototype),ArcCameraMosaic.prototype.init=function(e,t,r,a){ArcCameraAction.prototype.init.call(this,e,t),this.start=r,this.end=a},ArcCameraMosaic.prototype.update=function(e,t){ArcCameraAction.prototype.update.call(this,e,t);var r=Math.min(1,this.timeComplete/this.timeLimit);e.scale=(1-r)*this.start+r*this.end};var ArcCameraFadeOut=ArcBaseObject();ArcCameraFadeOut.prototype=Object.create(ArcCameraAction.prototype),ArcCameraFadeOut.prototype.init=function(e,t,r,a,i){ArcCameraAction.prototype.init.call(this,e,t),this.r=r,this.g=a,this.b=i},ArcCameraFadeOut.prototype.update=function(e,t){ArcCameraAction.prototype.update.call(this,e,t),e.fade[0]=this.r,e.fade[1]=this.g,e.fade[2]=this.b,e.fade[3]=Math.min(1,this.timeComplete/this.timeLimit)};var ArcCameraFadeIn=ArcBaseObject();ArcCameraFadeIn.prototype=Object.create(ArcCameraAction.prototype),ArcCameraFadeIn.prototype.init=function(e,t,r,a,i){ArcCameraAction.prototype.init.call(this,e,t),this.r=r,this.g=a,this.b=i},ArcCameraFadeIn.prototype.update=function(e,t){ArcCameraAction.prototype.update.call(this,e,t),e.fade[0]=this.r,e.fade[1]=this.g,e.fade[2]=this.b,e.fade[3]=1-Math.min(1,this.timeComplete/this.timeLimit)};var ArcCamera=ArcBaseObject();ArcCamera.prototype.init=function(){this.fade=new Float32Array([0,0,0,0]),this.offset=[0,0],this.scale=1,this.actionList=[]},ArcCamera.prototype.setOffset=function(e,t){this.offset[0]=e,this.offset[1]=t},ArcCamera.prototype.addAction=function(e){this.actionList.push(e)},ArcCamera.prototype.update=function(e){var t,r=this.actionList,a=[],i=r.length,o=0;for(o=0;o<i;++o)(t=r[o]).update(this,e),t.complete&&a.push(o);for(o=(i=a.length)-1;o>=0;--o)r.splice(a[o],1)},ArcCamera.prototype.clearActions=function(){this.actionList.length=0};var ArcGraphicsAdapter=ArcBaseObject();ArcGraphicsAdapter.prototype.init=function(){this.tileSheets={},this.spriteSheets={},this.size=[2,2],this.defaultFontInfo={font:"bold 12px sans-serif",fillStyle:"black",textAlign:"center"},this.camera=new ArcCamera,this.tiles=[]},ArcGraphicsAdapter.prototype.clear=function(){},ArcGraphicsAdapter.prototype.drawWaypoint=function(e,t,r){},ArcGraphicsAdapter.prototype.drawToDisplay=function(e){},ArcGraphicsAdapter.prototype.updateImage=function(e){},ArcGraphicsAdapter.prototype.drawImage=function(e,t,r,a,i,o,n,s,c){},ArcGraphicsAdapter.prototype.drawMessage=function(e,t,r,a,i,o){},ArcGraphicsAdapter.prototype.drawTileById=function(e,t,r,a,i){var o=this.tiles[e];if(o){var n=this.tileSheets[o.tileSheetName];this.drawTile(n,o.drawable(),t,r,a,i)}},ArcGraphicsAdapter.prototype.drawTile=function(e,t,r,a,i,o){this.drawImage(e.image,t.x,t.y,t.width,t.height,r,a,i,o)},ArcGraphicsAdapter.prototype.clear=function(){},ArcGraphicsAdapter.prototype.requestFullscreen=function(){},ArcGraphicsAdapter.prototype.addTileSheet=function(e,t,r){this.tileSheets[e]=new ArcTileSheet(e,t,r)},ArcGraphicsAdapter.prototype.addExistingTileSheet=function(e,t){this.tileSheets[e]=t},ArcGraphicsAdapter.prototype.updateTileSheet=function(e,t){var r=this.tileSheets[e];r&&r.update(t)},ArcGraphicsAdapter.prototype.addSpriteSheet=function(e,t,r,a){var i=new ArcSpriteSheet(t,!1,a);for(var o in r)i.setAnimation(o,r[o]);i.id=e,this.spriteSheets[e]=i},ArcGraphicsAdapter.prototype.addExistingSpriteSheet=function(e,t){this.spriteSheets[e]=t},ArcGraphicsAdapter.prototype.drawTileLayer=function(e){let t,r,a=0,i=this.camera.offset,o=e.length;for(;a<o;++a)t=e[a],(r=this.tileSheets[t.tile.tileSheetName])&&this.drawTile(r,t.tile.drawable(),t.location[0]-i[0],t.location[1]-i[1],t.size[0],t.size[1]);if(window.debugMode){let r;for(a=0;a<o;++a)r=(t=e[a]).tile.walkable?"#AAA":"#000",this.drawLine(t.location[0],t.location[1],t.location[2],t.location[3],r),this.drawLine(t.location[2],t.location[1],t.location[0],t.location[3],r)}},ArcGraphicsAdapter.prototype.drawTileLayerWithOffset=function(e,t,r){for(var a=this.camera.offset,i=a[0]/e.tileDimension[0],o=a[1]/e.tileDimension[1],n=Math.floor(i),s=Math.floor(o),c=i=-(i-n)*e.tileDimension[0],u=o=-(o-s)*e.tileDimension[1],l=this.size[0],p=this.size[1],h=e.dimension[0],x=e.dimension[1],d=0,m=n,f=this.tileSheets[e.tileSheet.name];u<=p&&s<x;){for(d=s*h+n;c<l&&n<h;){var A=e.data[d];if(A>=0){var v=e.tileSheet.tiles[A];v&&v.isDrawable&&this.drawTile(f,v.drawable(),c,u,e.tileDimension[0],e.tileDimension[1])}++n,t&&n>=h&&(n=0),++d,c+=e.tileDimension[0]}n=m,c=i,u+=e.tileDimension[0],++s,r&&s>=x&&(s=0)}},ArcGraphicsAdapter.prototype.update=function(e){this.camera.update(e);for(var t in this.tiles)this.tiles[t].update(e)},ArcGraphicsAdapter.prototype.drawLine=function(e,t,r,a,i){},ArcGraphicsAdapter.prototype.drawPolygon=function(e,t){},ArcGraphicsAdapter.prototype.resize=function(e,t){this.size[0]=e,this.size[1]=t};var ArcCanvasAdapter=ArcBaseObject();ArcCanvasAdapter.prototype=Object.create(ArcGraphicsAdapter.prototype),ArcCanvasAdapter.prototype.init=function(e){ArcGraphicsAdapter.prototype.init.call(this);var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");r.imageSmoothingEnabled=!1,this.size[0]=e.width,this.size[1]=e.height,this.context=r,this.canvas=e},ArcCanvasAdapter.prototype.drawMessage=function(e,t,r,a,i,o){var n=this.context;void 0==a&&(a=this.defaultFontInfo),n.font=a.font,n.textAlign=a.textAlign,i?(n.fillStyle=o,n.fillRect(i[0],i[1],i[2],i[3]),n.fillStyle=a.fillStyle,n.fillText(e,t+i[0]+(i[2]>>1),r+i[1]+(i[3]>>1))):(n.fillStyle=a.fillStyle,n.fillText(e,t,r))},ArcCanvasAdapter.prototype.drawToDisplay=function(e){var t=this.canvas,r=t.getContext("2d"),a=this.context.canvas;if(e&&r.clearRect(0,0,t.width,t.height),1!=this.camera.scale){var i=this.camera.scale,o=t.width*i,n=t.height*i;r.drawImage(a,0,0,t.width,t.height,0,0,o,n),r.drawImage(t,0,0,o,n,0,0,t.width,t.height)}else r.drawImage(a,0,0);var s=this.camera.fade;s[3]>=0&&(r.fillStyle="rgba("+Math.floor(255*s[0])+","+Math.floor(255*s[1])+","+Math.floor(255*s[2])+","+s[3]+")",r.fillRect(0,0,t.width,t.height))},ArcCanvasAdapter.prototype.getPixelData=function(e,t,r,a){return this.context.getImageData(e,t,r,a)},ArcCanvasAdapter.prototype.setPixelData=function(e,t,r){this.context.putImageData(e,t,r)},ArcCanvasAdapter.prototype.requestFullscreen=function(){var e=this.canvas,t=this.screen;e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullscreen?e.mozRequestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),e.width=t.width,e.height=t.height},ArcCanvasAdapter.prototype.clear=function(){var e=this.context,t=this.canvas;e.clearRect(0,0,t.width,t.height)},ArcCanvasAdapter.prototype.drawTileLayer=function(e){this.camera.offset[0]|=0,this.camera.offset[1]|=0,ArcGraphicsAdapter.prototype.drawTileLayer.call(this,e)},ArcCanvasAdapter.prototype.drawTileLayerWithOffset=function(e,t,r){ArcGraphicsAdapter.prototype.drawTileLayerWithOffset.call(this,e,t,r)},ArcCanvasAdapter.prototype.drawImage=function(e,t,r,a,i,o,n,s,c){e&&this.context.drawImage(e,t,r,a,i,o,n,s,c)},ArcCanvasAdapter.prototype.drawWaypoint=function(e){var t=this.camera.offset,r=this.context;r.beginPath(),r.fillStyle="rgba(255, 255, 0, 0.5)",r.arc(e[0]-t[0],e[1]-t[1],10,0,2*Math.PI,!1),r.fill()},ArcCanvasAdapter.prototype.drawLine=function(e,t,r,a,i){var o=this.camera.offset,n=this.context;i||(i="#0F0"),n.strokeStyle=i,n.beginPath(),n.moveTo(e-o[0],t-o[1]),n.lineTo(r-o[0],a-o[1]),n.stroke()},ArcCanvasAdapter.prototype.drawPolygon=function(e,t,r){var a=this.camera.offset,i=this.context;if(i){i.fillStyle="rgba("+Math.floor(255*e[0])+","+Math.floor(255*e[1])+","+Math.floor(255*e[2])+","+e[3]+")",i.beginPath(),i.moveTo(t[0]-a[0],t[1]-a[1]);for(var o=4;o<t.length;o+=4)i.lineTo(t[o]-a[0],t[o+1]-a[1]);i.closePath(),i.fill()}};var ArcGLCanvasAdapter=ArcBaseObject(),drawBlurred=function(e,t,r,a){e.useProgram(r),e.disable(e.BLEND),e.uniform1i(r.uBlurType,1),e.uniform4fv(r.uFadeColor,this.camera.fade),e.uniform1f(r.uScale,this.camera.scale),e.drawArrays(e.TRIANGLE_STRIP,0,a.numItems),t&&e.bindFramebuffer(e.FRAMEBUFFER,null),e.uniform1i(r.uBlurType,2),e.drawArrays(e.TRIANGLE_STRIP,0,a.numItems),e.enable(e.BLEND)},drawNonBlurred=function(e,t,r,a){e.useProgram(r),e.disable(e.BLEND),e.uniform1i(r.uBlurType,0),e.uniform4fv(r.uFadeColor,this.camera.fade),e.uniform1f(r.uScale,this.camera.scale),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawArrays(e.TRIANGLE_STRIP,0,a.numItems),e.enable(e.BLEND)},swapMessageBuffer=function(e,t){let r=this.textCanvas;e.useProgram(this.textProgram),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.textbufferTexture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,r),e.drawArrays(e.TRIANGLE_STRIP,0,t.numItems),e.activeTexture(e.TEXTURE0)};ArcGLCanvasAdapter.prototype=Object.create(ArcGraphicsAdapter.prototype),ArcGLCanvasAdapter.prototype.init=function(e){ArcGraphicsAdapter.prototype.init.call(this);var t=document.createElement("canvas");$(t).css("background-color","rgba(255, 0, 255, 0)"),t.width=e.width,t.height=e.height;var r;try{r=e.getContext("webgl","experimental-webgl")}catch(e){throw"WebGL not supported."}this.textCanvas=t,this.textContext=t.getContext("2d"),this.program=null,this.waypointProgram=null,this.postProgram=null,this.textProgram=null,this.backbuffer=null,this.backbufferTexture=null,this.textbufferTexture=null,this.context=r,this.vBuffer=null,this.size[0]=e.width,this.size[1]=e.height,this.canvas=e,this.initGL()},ArcGLCanvasAdapter.prototype.initGL=function(){var e=this.context,t=this.canvas,r=function(e,t,r,a,i,o,n){var s=r-t,c=a-i,u=n-o;return e[0]=2/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2/c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-1/u,e[11]=0,e[12]=-(r+t)/s,e[13]=-(a+i)/c,e[14]=-o/u,e[15]=1,e},a=function(e,t){var r=Math.sin(t),a=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=-r,e[7]=0,e[8]=0,e[9]=r,e[10]=a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},i=function(t,r){var a=e.createShader(t);return e.shaderSource(a,r),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)?a:(alert(e.getShaderInfoLog(a)),null)},o=function(t,r){var a=i(e.FRAGMENT_SHADER,r),o=i(e.VERTEX_SHADER,t),n=e.createProgram();return e.attachShader(n,o),e.attachShader(n,a),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)||alert("Could not initialize shaders."),n};e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),e.clearColor(0,0,0,1),textProgram=o("precision mediump float;\nattribute vec2 aVertPos;\nvarying vec2 vTexPos;\nvoid main(void){\nvTexPos = vec2(aVertPos.x, 1.0 - aVertPos.y);\ngl_Position = vec4((aVertPos * 2.0) - 1.0, 0.0, 1.0);\n}","precision mediump float;\nuniform sampler2D uTexture;\nvarying vec2 vTexPos;\nvoid main(void){\ngl_FragColor = texture2D(uTexture, vTexPos);\n}"),e.useProgram(textProgram),textProgram.aVertPos=e.getAttribLocation(textProgram,"aVertPos"),textProgram.uTexture=e.getUniformLocation(textProgram,"uTexture"),e.uniform1i(textProgram.uTexture,2),this.textProgram=textProgram;var n=o("precision mediump float;\nattribute vec2 aVertPos;\nvarying vec2 vTexPos;\nvoid main(void){\nvTexPos = vec2(aVertPos.x, aVertPos.y);\ngl_Position = vec4((aVertPos * 2.0) - 1.0, 0.0, 1.0);\n}","precision mediump float;\nuniform vec2 uSpace;\nuniform lowp int uBlurType;\nuniform sampler2D uTexture;\nuniform vec4 uFadeColor;\nuniform float uScale;\nvarying vec2 vTexPos;\nvarying vec2 vSpace;\nvec4 getTexture(sampler2D tex, vec2 pos){\nif(uScale == 1.0) { return texture2D(tex, pos); };\nvec2 tileLocation = (floor(uScale * (pos / uSpace)) / uScale) * uSpace;\nreturn texture2D(tex, tileLocation);\n}\nvec4 blur(float p){\nvec4 tMain = getTexture(uTexture, vTexPos);\nif(p <= 0.0) { return tMain; }\nvec4 left, right;\nif(uBlurType == 1){\nleft = getTexture(uTexture, vec2(vTexPos.x, vTexPos.y - uSpace.y));\nright = getTexture(uTexture, vec2(vTexPos.x, vTexPos.y + uSpace.y));\n}else if(uBlurType == 2){\nleft = getTexture(uTexture, vec2(vTexPos.x - uSpace.x, vTexPos.y));\nright = getTexture(uTexture, vec2(vTexPos.x + uSpace.x, vTexPos.y));\n}else{return tMain;}\nfloat outP = sqrt(p * 2.0) / 3.0;\nreturn (outP * (left + right)) + ((1.0 - (2.0 * outP)) * tMain);\n}\nvoid main(void){\nfloat y = pow((vTexPos.y * 2.0) - 1.0, 2.0);\ny = max(y, 0.0);\ngl_FragColor = blur(y);\nif(uFadeColor.a > 0.0){\ngl_FragColor.rgb = ((1.0 - uFadeColor.a) * gl_FragColor.rgb) + (uFadeColor.a * uFadeColor.rgb);\n}\n}");e.useProgram(n),n.aVertPos=e.getAttribLocation(n,"aVertPos"),n.uSpace=e.getUniformLocation(n,"uSpace"),n.uTexture=e.getUniformLocation(n,"uTexture"),n.uBlurType=e.getUniformLocation(n,"uBlurType"),n.uFadeColor=e.getUniformLocation(n,"uFadeColor"),n.uScale=e.getUniformLocation(n,"uScale"),e.uniform1i(n.uTexture,1),this.postProgram=n;var s=o("precision mediump float;\nuniform vec2 uScreen;\nuniform vec4 uDimension;\nattribute vec2 aVertPos;\nvarying vec2 vTexPos;\nvoid main(void){\nvTexPos = (vec2(aVertPos.x, aVertPos.y) * 2.0) - 1.0;\ngl_Position.zw = vec2(0.0, 1.0);\ngl_Position.x = ((2.0 * uDimension.x) - uScreen.x + (2.0 * aVertPos.x * uDimension.z)) / uScreen.x;\ngl_Position.y = ((-2.0 * uDimension.y) + uScreen.y - (2.0 * aVertPos.y * uDimension.w)) / uScreen.y;\n}","precision mediump float;\nvarying vec2 vTexPos;\nvoid main(void){\nfloat d = distance(vTexPos, vec2(0,0));\nif(d > 1.0){ discard; }\nd = 1.0 - d;\nd *= d;\ngl_FragColor = vec4(d, d, d * 0.1, 1.0);\n}");e.useProgram(s),s.aVertPos=e.getAttribLocation(s,"aVertPos"),s.uScreen=e.getUniformLocation(s,"uScreen"),s.uDimension=e.getUniformLocation(s,"uDimension"),this.waypointProgram=s;var c=o("precision mediump float;\nuniform mat4 mOMatrix;\nuniform mat4 mRMatrix;\nuniform vec2 uScreen;\nuniform vec2 uOffset;\nattribute vec2 aVertPos;\nattribute vec2 aTexPos;\nvarying vec2 vTexPos;\nvoid main(void){\nvTexPos = aTexPos;\ngl_Position.zw = vec2(0.0, 1.0);\ngl_Position.xy = vec2(uScreen.x, -uScreen.y);\ngl_Position.xy = ((2.0 * (aVertPos.xy - uOffset.xy)) - uScreen.xy) / gl_Position.xy;\ngl_Position = mRMatrix * gl_Position;\ngl_Position = mOMatrix * gl_Position;\n}","precision mediump float;\nuniform vec4 uColor;\nuniform sampler2D uTexture;\nvarying vec2 vTexPos;\nvoid main(void){\ngl_FragColor = texture2D(uTexture, vTexPos) * uColor;\n}");e.useProgram(c),c.aVertPos=e.getAttribLocation(c,"aVertPos"),c.aTexPos=e.getAttribLocation(c,"aTexPos"),c.mOMatrix=e.getUniformLocation(c,"mOMatrix"),c.mRMatrix=e.getUniformLocation(c,"mRMatrix"),c.uScreen=e.getUniformLocation(c,"uScreen"),c.uOffset=e.getUniformLocation(c,"uOffset"),c.uColor=e.getUniformLocation(c,"uColor"),c.uTexture=e.getUniformLocation(c,"uTexture"),e.uniform1i(c.uTexture,0);var u=new Float32Array(16);r(u,-1,1,1,-1,-1,-10),e.uniformMatrix4fv(c.mOMatrix,!1,u);var l=new Float32Array(16);a(l,0),e.uniformMatrix4fv(c.mRMatrix,!1,l),c.bPointBuffer=e.createBuffer(),this.polygonProgram=c;var p=o("precision mediump float;\nuniform mat4 mOMatrix;\nuniform mat4 mRMatrix;\nuniform vec2 uScreen;\nuniform vec4 uDimension;\nattribute vec2 aVertPos;\nvarying vec2 vTexPos;\nvoid main(void){\nvTexPos = vec2(aVertPos.x, aVertPos.y);\ngl_Position.zw = vec2(-1.6, 1.0);\ngl_Position.x = ((2.0 * uDimension.x) - uScreen.x + (2.0 * aVertPos.x * uDimension.z)) / uScreen.x;\ngl_Position.y = ((-2.0 * uDimension.y) + uScreen.y - (2.0 * aVertPos.y * uDimension.w)) / uScreen.y;\ngl_Position = mRMatrix * gl_Position;\ngl_Position.z -= 0.0;\ngl_Position = mOMatrix * gl_Position;\n}","precision mediump float;\nuniform float uScaleDist;\nuniform vec2 uTexDimension;\nuniform vec4 uTileDimension;\nuniform sampler2D uTexture;\nvarying vec2 vTexPos;\nvec2 getAvailableTexturePosition(vec2 texPos){\nvec2 outVal = max(min(texPos, vec2(1.0, 1.0)), vec2(0.01, 0.01));\noutVal *= uTileDimension.zw;\noutVal += uTileDimension.xy;\nreturn outVal / uTexDimension;\n}\nvec4 scaled(vec2 texPos){\nvec2 scale = uScaleDist * 1.0/uTileDimension.zw;\nvec2 texCoord[9];\nvec4 texColor[9];\nvec4 avg;\nfloat d;\nfloat dCheck;\ntexCoord[0] = getAvailableTexturePosition(vec2(texPos.x - scale.x, texPos.y - scale.y));\ntexCoord[1] = getAvailableTexturePosition(vec2(texPos.x - 0.0, texPos.y - scale.y));\ntexCoord[2] = getAvailableTexturePosition(vec2(texPos.x + scale.x, texPos.y - scale.y));\ntexCoord[3] = getAvailableTexturePosition(vec2(texPos.x - scale.x, texPos.y - 0.0));\ntexCoord[4] = getAvailableTexturePosition(vec2(texPos.x - 0.0, texPos.y - 0.0));\ntexCoord[5] = getAvailableTexturePosition(vec2(texPos.x + scale.x, texPos.y - 0.0));\ntexCoord[6] = getAvailableTexturePosition(vec2(texPos.x - scale.x, texPos.y - scale.y));\ntexCoord[7] = getAvailableTexturePosition(vec2(texPos.x - 0.0, texPos.y - scale.y));\ntexCoord[8] = getAvailableTexturePosition(vec2(texPos.x + scale.x, texPos.y - scale.y));\ntexColor[0] = texture2D(uTexture, texCoord[0]);\ntexColor[1] = texture2D(uTexture, texCoord[1]);\ntexColor[2] = texture2D(uTexture, texCoord[2]);\ntexColor[3] = texture2D(uTexture, texCoord[3]);\ntexColor[4] = texture2D(uTexture, texCoord[4]);\ntexColor[5] = texture2D(uTexture, texCoord[5]);\ntexColor[6] = texture2D(uTexture, texCoord[6]);\ntexColor[7] = texture2D(uTexture, texCoord[7]);\ntexColor[8] = texture2D(uTexture, texCoord[8]);\navg = texColor[0] + texColor[1] + texColor[2] + texColor[3] + texColor[4] + texColor[5] + texColor[6] + texColor[7] + texColor[8];\nif(avg.a == 0.0) { discard; }\navg = avg / 9.0;\nvec4 currentColor = texColor[5];\nd = distance(avg, currentColor);\ndCheck = distance(avg, texColor[0]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[0]; }\ndCheck = distance(avg, texColor[1]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[1]; }\ndCheck = distance(avg, texColor[2]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[2]; }\ndCheck = distance(avg, texColor[3]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[3]; }\ndCheck = distance(avg, texColor[4]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[4]; }\ndCheck = distance(avg, texColor[6]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[6]; }\ndCheck = distance(avg, texColor[7]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[7]; }\ndCheck = distance(avg, texColor[8]);\nif(dCheck < d){ d = dCheck; currentColor = texColor[8]; }\nreturn currentColor;\n}\nvoid main(void){\ngl_FragColor = scaled(vTexPos);\n}");e.useProgram(p),p.aVertPos=e.getAttribLocation(p,"aVertPos"),p.uScreen=e.getUniformLocation(p,"uScreen"),p.uDimension=e.getUniformLocation(p,"uDimension"),p.uTileDimension=e.getUniformLocation(p,"uTileDimension"),p.uTexDimension=e.getUniformLocation(p,"uTexDimension"),p.uTexture=e.getUniformLocation(p,"uTexture"),p.uScaleDist=e.getUniformLocation(p,"uScaleDist"),p.mOMatrix=e.getUniformLocation(p,"mOMatrix"),p.mRMatrix=e.getUniformLocation(p,"mRMatrix"),e.uniform1i(p.uTexture,0),e.uniform1f(p.uScaleDist,.5),r(u=new Float32Array(16),-1,1,1,-1,-1,-10),e.uniformMatrix4fv(p.mOMatrix,!1,u),a(l=new Float32Array(16),0),e.uniformMatrix4fv(p.mRMatrix,!1,l),this.program=p;var h=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,h);var x=[1,1,0,1,1,0,0,0];e.bufferData(e.ARRAY_BUFFER,new Float32Array(x),e.STATIC_DRAW),h.itemSize=2,h.numItems=4,this.vBuffer=h,e.useProgram(textProgram),e.enableVertexAttribArray(textProgram.aVertPos),e.vertexAttribPointer(textProgram.aVertPos,h.itemSize,e.FLOAT,!1,0,0),e.useProgram(n),e.enableVertexAttribArray(n.aVertPos),e.vertexAttribPointer(n.aVertPos,h.itemSize,e.FLOAT,!1,0,0),e.useProgram(s),e.enableVertexAttribArray(s.aVertPos),e.vertexAttribPointer(s,h.itemSize,e.FLOAT,!1,0,0),e.useProgram(p),e.enableVertexAttribArray(p.aVertPos),e.vertexAttribPointer(p.aVertPos,h.itemSize,e.FLOAT,!1,0,0),this.resize(t.width,t.height)},ArcGLCanvasAdapter.prototype.loadTexture=function(e,t){var r=this.context,a=r.createTexture();return r.bindTexture(r.TEXTURE_2D,a),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),a},ArcGLCanvasAdapter.prototype.updateImage=function(e){let t=this.context;e.texture?(t.bindTexture(t.TEXTURE_2D,e.texture),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,e)):e.texture=this.loadTexture(e)},ArcGLCanvasAdapter.prototype.drawImage=function(e,t,r,a,i,o,n,s,c){if(e&&e.complete){var u=this.context,l=this.program;u.uniform4f(l.uDimension,o,n,s,c),u.uniform2f(l.uTexDimension,e.width,e.height),u.uniform4f(l.uTileDimension,t,r,a,i),u.activeTexture(u.TEXTURE0),e.texture||(e.texture=this.loadTexture(e,!1)),u.bindTexture(u.TEXTURE_2D,e.texture),u.enableVertexAttribArray(l.aVertPos),u.vertexAttribPointer(l.aVertPos,this.vBuffer.itemSize,u.FLOAT,!1,0,0),u.drawArrays(u.TRIANGLE_STRIP,0,this.vBuffer.numItems)}},ArcGLCanvasAdapter.prototype.requestFullscreen=function(){},ArcGLCanvasAdapter.prototype.addTileSheet=function(e,t,r){var a=this;this.tileSheets[e]=new ArcTileSheet(e,t,r,function(e){e.image.texture&&null!==e.image.texture&&a.context.deleteTexture(e.image.texture),e.image.texture=a.loadTexture(e.image,!1)})},ArcGLCanvasAdapter.prototype.addExistingTileSheet=function(e,t){var r=this;t.onImageUpdate=function(e){e.image.texture&&null!==e.image.texture&&r.context.deleteTexture(e.image.texture),e.image.texture=r.loadTexture(e.image,!1)},this.tileSheets[e]=t},ArcGLCanvasAdapter.prototype.addSpriteSheet=function(e,t,r,a){var i=this,o=new ArcSpriteSheet(t,function(e){e.image.texture&&null!==e.image.texture&&i.context.deleteTexture(e.image.texture),e.image.texture=i.loadTexture(e.image,!0)},a);for(var n in r)o.setAnimation(n,r[n]);o.id=e,this.spriteSheets[e]=o},ArcGLCanvasAdapter.prototype.addExistingSpriteSheet=function(e,t){var r=this;t.onImageUpdate=function(e){e.image.texture&&null!==e.image.texture&&r.context.deleteTexture(e.image.texture),e.image.texture=r.loadTexture(e.image,!0)},this.spriteSheets[e]=t,t.updateColorset()},ArcGLCanvasAdapter.prototype.clear=function(){var e=this.textCanvas,t=this.context;this.textContext.clearRect(0,0,e.width,e.height),t.useProgram(this.program),t.bindFramebuffer(t.FRAMEBUFFER,this.backbuffer),t.clear(t.COLOR_BUFFER_BIT)},ArcGLCanvasAdapter.prototype.drawWaypoint=function(e){var t=this.camera.offset,r=this.context,a=this.waypointProgram;r.useProgram(a),r.uniform4f(a.uDimension,e[0]-t[0]-32,e[1]-t[1]-32,64,64),r.enableVertexAttribArray(a.aVertPos),r.vertexAttribPointer(a.aVertPos,this.vBuffer.itemSize,r.FLOAT,!1,0,0),r.blendFunc(r.ONE,r.ONE),r.drawArrays(r.TRIANGLE_STRIP,0,this.vBuffer.numItems),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.useProgram(this.program)},ArcGLCanvasAdapter.prototype.drawMessage=function(e,t,r,a,i,o){var n=this.textContext;void 0==a&&(a=this.defaultFontInfo),n.font=a.font,n.textAlign=a.textAlign,n.fillStyle=a.fillStyle,n.fillText(e,t,r)},ArcGLCanvasAdapter.prototype.drawLine=function(e,t,r,a,i){var o=this.camera.offset,n=this.textContext;i||(i="#0F0"),n.strokeStyle=i,n.beginPath(),n.moveTo(e-o[0],t-o[1]),n.lineTo(r-o[0],a-o[1]),n.stroke()},ArcGLCanvasAdapter.prototype.drawPolygon=function(e,t,r){if(r&&r.complete){var a=this.context,i=this.polygonProgram,o=t.length>>2,n=this.camera.offset;a.useProgram(i),a.uniform4fv(i.uColor,e),a.uniform2f(i.uOffset,n[0],n[1]),a.activeTexture(a.TEXTURE0),r.texture||(r.texture=this.loadTexture(r,!1)),a.bindTexture(a.TEXTURE_2D,r.texture),a.bindBuffer(a.ARRAY_BUFFER,i.bPointBuffer),a.bufferData(a.ARRAY_BUFFER,t,a.STATIC_DRAW),a.enableVertexAttribArray(i.aVertPos),a.enableVertexAttribArray(i.aTexPos),a.vertexAttribPointer(i.aVertPos,2,a.FLOAT,!1,16,0),a.vertexAttribPointer(i.aTexPos,2,a.FLOAT,!1,16,8),a.drawArrays(a.TRIANGLE_STRIP,0,o),a.bindBuffer(a.ARRAY_BUFFER,this.vBuffer),a.useProgram(this.program)}},ArcGLCanvasAdapter.prototype.drawToDisplay=function(e){var t=this.context,r=this.postProgram,a=this.vBuffer;t.enableVertexAttribArray(r.aVertPos),t.vertexAttribPointer(r.aVertPos,this.vBuffer.itemSize,t.FLOAT,!1,0,0),drawNonBlurred.call(this,t,!0,r,a),window.debugMode&&swapMessageBuffer.call(this,t,a)},ArcGLCanvasAdapter.prototype.resize=function(e,t){ArcGraphicsAdapter.prototype.resize.call(this,e,t);var r=this.context;r.viewportWidth=e,r.viewportHeight=t,r.viewport(0,0,r.viewportWidth,r.viewportHeight);var a=this.postProgram;r.useProgram(a),r.uniform2f(a.uSpace,1/e,1/t);var i=this.waypointProgram;r.useProgram(i),r.uniform2f(i.uScreen,e,t);var o=this.polygonProgram;r.useProgram(o),r.uniform2f(o.uScreen,e,t);var n=this.program;r.useProgram(n),r.uniform2f(n.uScreen,e,t),r.activeTexture(r.TEXTURE2),this.textbufferTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.textbufferTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,this.textCanvas),r.activeTexture(r.TEXTURE1),this.backbuffer=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,this.backbuffer),this.backbufferTexture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.backbufferTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,null),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.backbufferTexture,0),r.bindTexture(r.TEXTURE_2D,this.backbufferTexture),r.activeTexture(r.TEXTURE0),r.bindFramebuffer(r.FRAMEBUFFER,null)},ArcGLCanvasAdapter.prototype.setScaleDist=function(e){var t=this.context,r=this.program;t.useProgram(r),t.uniform1f(r.uScaleDist,e)};var ArcGL2CanvasAdapter=ArcBaseObject();ArcGL2CanvasAdapter.prototype=Object.create(ArcGLCanvasAdapter.prototype),ArcGL2CanvasAdapter.prototype.init=function(e){ArcGraphicsAdapter.prototype.init.call(this);var t=document.createElement("canvas");$(t).css("background-color","rgba(255, 0, 255, 0)"),t.width=e.width,t.height=e.height;var r;try{r=e.getContext("webgl2")}catch(e){throw"WebGL2 not supported."}this.textCanvas=t,this.textContext=t.getContext("2d"),this.program=null,this.waypointProgram=null,this.postProgram=null,this.textProgram=null,this.backbuffer=null,this.backbufferTexture=null,this.textbufferTexture=null,this.context=r,this.vBuffer=null,this.size[0]=e.width,this.size[1]=e.height,this.canvas=e,this.initGL()};var ArcMobileCanvasAdapter=ArcBaseObject();ArcMobileCanvasAdapter.prototype=Object.create(ArcCanvasAdapter.prototype),ArcMobileCanvasAdapter.prototype.init=function(e){ArcCanvasAdapter.prototype.init.call(this,e),this.context.imageSmoothingEnabled=!1},ArcMobileCanvasAdapter.prototype.requestFullscreen=function(){var e=this.canvas,t=this.backgroundCanvas;e.width=window.innerWidth,e.height=window.innerHeight,$(e).css("position","absolute"),$(e).css("top","0px"),$(e).css("left","0px"),t.width=e.width,t.height=e.height,this.context=t.getContext("2d")};function arcGetControlAdapter(t){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?new ArcMobileControlAdapter(t):new ArcControlAdapter(t)}var ArcBaseControlAdapter=ArcBaseObject();ArcBaseControlAdapter.prototype.init=function(){this.actions=[]},ArcBaseControlAdapter.prototype.pullActionList=function(){var t=this.actions;return this.actions=[],t},ArcBaseControlAdapter.prototype.addAction=function(t,e){var o={id:t,timestamp:(new Date).getTime(),data:e};return this.actions.push(o),o};var ArcKeyboardAdapter=ArcBaseObject();ArcKeyboardAdapter.prototype=Object.create(ArcBaseControlAdapter.prototype),ArcKeyboardAdapter.prototype.init=function(t){ArcBaseControlAdapter.prototype.init.call(this),this.keys=new Uint8Array(32);var e=this,o=$(document.body);o.keydown(function(t){var o=t.keyCode;e.setKey(o,!0),e.addAction(CONTROL_KEY_DOWN,{key:o})}),o.keyup(function(t){var o=t.keyCode;e.setKey(o,!1),e.addAction(CONTROL_KEY_UP,{key:o})})},ArcKeyboardAdapter.prototype.setKey=function(t,e){var o=t>>3,r=7&t;e?this.keys[o]|=1<<r:this.keys[o]&=~(1<<r)},ArcKeyboardAdapter.prototype.getKey=function(t){var e=t>>3,o=1<<(7&t);return(this.keys[e]&o)>0};var ArcControlAdapter=ArcBaseObject();ArcControlAdapter.prototype=Object.create(ArcBaseControlAdapter.prototype),ArcControlAdapter.prototype.init=function(t){ArcBaseControlAdapter.prototype.init.call(this);var e=this,o=!1,r=$(t);this.keys=new Uint8Array(32),r.mousedown(function(t){t.preventDefault(),o=!0;var n=t.pageX-r.offset().left,a=t.pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_DOWN,{x:n,y:a})}),r.mouseup(function(t){t.preventDefault(),o=!1;var n=t.pageX-r.offset().left,a=t.pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_UP,{x:n,y:a})}),r.mousemove(function(t){if(t.preventDefault(),o){var n=t.pageX-r.offset().left,a=t.pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_DRAG,{x:n,y:a})}}),r.keydown(function(t){var o=t.keyCode;e.setKey(o,!0),e.addAction(CONTROL_KEY_DOWN,{key:o})}),r.keyup(function(t){var o=t.keyCode;e.setKey(o,!1),e.addAction(CONTROL_KEY_UP,{key:o})})},ArcControlAdapter.prototype.setKey=function(t,e){var o=t>>3,r=7&t;e?this.keys[o]|=1<<r:this.keys[o]&=~(1<<r)},ArcControlAdapter.prototype.getKey=function(t){var e=t>>3,o=1<<(7&t);return(this.keys[e]&o)>0};var ArcMobileControlAdapter=ArcBaseObject();ArcMobileControlAdapter.prototype=Object.create(ArcBaseControlAdapter.prototype),ArcMobileControlAdapter.prototype.init=function(t){var e=this,o=!1,r=$(t);r.bind("touchstart",function(t){t.preventDefault(),o=!0;var n=t.originalEvent.changedTouches[0].pageX-r.offset().left,a=t.originalEvent.changedTouches[0].pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_DOWN,{x:n,y:a})}),r.bind("touchend",function(t){t.preventDefault(),o=!1;var n=t.originalEvent.changedTouches[0].pageX-r.offset().left,a=t.originalEvent.changedTouches[0].pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_UP,{x:n,y:a})}),r.bind("touchmove",function(t){if(o){t.preventDefault();var n=t.originalEvent.changedTouches[0].pageX-r.offset().left,a=t.originalEvent.changedTouches[0].pageY-r.offset().top;e.addAction(CONTROL_MOUSE1_DRAG,{x:n,y:a})}})};function arcGetAudioAdapter(){var o;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);try{o=new ArcAudioAdapter}catch(t){console.log(t),o=new ArcBaseAudioAdapter}return o}var ArcBaseAudioAdapter=ArcBaseObject();ArcBaseAudioAdapter.prototype.init=function(){},ArcBaseAudioAdapter.prototype.setVolume=function(o){},ArcBaseAudioAdapter.prototype.getVolume=function(){},ArcBaseAudioAdapter.prototype.loadSound=function(o,t,e){},ArcBaseAudioAdapter.prototype.playSound=function(o){},ArcBaseAudioAdapter.prototype.stopSound=function(o){},ArcBaseAudioAdapter.prototype.updateSound=function(o,t){};var ArcAudioAdapter=ArcBaseObject();ArcAudioAdapter.prototype=Object.create(ArcBaseAudioAdapter.prototype),ArcAudioAdapter.prototype.init=function(){var o,t;try{window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,(t=(o=new AudioContext).createGain()).gain.value=1,t.connect(o.destination)}catch(o){throw"Web Audio API is not supported in this browser."}this.context=o,this.gainNode=t,this.buffers={}},ArcAudioAdapter.prototype.setVolume=function(o){this.gainNode.gain.value=o},ArcAudioAdapter.prototype.getVolume=function(){return this.gainNode.gain.value},ArcAudioAdapter.prototype.loadSound=function(o,t,e){var n=this.buffers;if(n[o.name])t&&this.playSound(o);else{var r=this.context,i=new XMLHttpRequest,a=this;o.state=1,i.open("GET",o.url,!0),i.responseType="arraybuffer",n[o.name]=!1,i.onload=function(){r.decodeAudioData(i.response,function(e){n[o.name]=e,t&&a.playSound(o)},e),o.state=2},i.send()}},ArcAudioAdapter.prototype.playSound=function(o,t){var e=this.buffers[o.name];if(e){var n=this.context,r=n.createBufferSource();return r.buffer=e,o.gain=n.createGain(),o.gain.gain.value=o.volume,r.connect(o.gain),o.gain.connect(this.gainNode),r.loop=o.loop,r.start(0),o.source=r,r}return this.loadSound(o,!0),null},ArcAudioAdapter.prototype.stopSound=function(o,t){o&&o.source&&o.source.stop()},ArcAudioAdapter.prototype.updateSound=function(o,t){if(o.radius>0){var e=o.location[0]-t[0],n=o.location[1]-t[1],r=Math.sqrt(e*e+n*n);o.volume=Math.pow(Math.max(1-r*o.radius,0),2),null!==o.gain&&(o.gain.gain.value=o.volume)}};var ArcOverlay=ArcBaseObject();ArcOverlay.prototype.init=function(i){this.parent=i,this.image=null,this.dimension=new Uint16Array(2),this.anchors=new Uint16Array([Number.NaN,Number.NaN,Number.NaN,Number.NaN]),this.elements=[],this.isShown=!1,this.drawingArea=new Uint16Array(4),this.onCloseComplete=null},ArcOverlay.prototype.show=function(){this.isShown=!0},ArcOverlay.prototype.close=function(){this.isShown=!1,this.onCloseComplete&&onCloseComplete()},ArcOverlay.prototype.handleActions=function(i){},ArcOverlay.prototype.animate=function(i){for(var t=elements.length;t-- >-1;)this.elements[t].animate(i)},ArcOverlay.prototype.calculateDrawingArea=function(i){var t,a,r,e,s;null===this.parent?(t=0,a=0,r=i.size[0],i.size[1]):(t=this.parent.drawingArea[0],a=this.parent.drawingArea[1],r=this.parent.drawingArea[2],this.parent.drawingArea[3]),isNaN(this.anchors[3])?(s=this.dimension[0],e=isNaN(this.anchors[1])?0:r+this.anchors[3]-s):(e=this.anchors[3],s=isNaN(this.anchors[1])?this.dimension[0]:r-(e+this.anchors[1])),isNaN(this.anchors[2])?(s=this.dimension[1],e=isNaN(this.anchors[0])?0:r+this.anchors[2]-s):(e=this.anchors[2],s=isNaN(this.anchors[0])?this.dimension[1]:r-(e+this.anchors[0])),this.drawingArea[0]=e+t,this.drawingArea[1]=void 0+a,this.drawingArea[2]=s,this.drawingArea[3]=void 0},ArcOverlay.prototype.draw=function(i){if(this.isShown){this.calculateDrawingArea(),i.drawImage(this.image,0,0,this.image.width,this.image.height,this.drawingArea[0],this.drawingArea[1],this.drawingArea[2],this.drawingArea[3]);for(var t=elements.length;t-- >-1;)this.elements[t].draw(i)}};function arcGetParameter(t){for(var e=window.location.search.substring(1).split("&"),i=0;i<e.length;++i){var n=e[i].split("=");if(n[0].toLowerCase()===t.toLowerCase())return n[1]}return!1}window.arcRequestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)};var ArcSettings=ArcBaseObject();ArcSettings.Current=null,ArcSettings.prototype.init=function(t){this.name=t,this.general={memory:LEVEL_MED}},ArcSettings.prototype.save=function(){localStorage.setItem(this.name,JSON.stringify(this))},ArcSettings.prototype.load=function(t){let e=null;if(e=JSON.parse(localStorage.getItem(this.name)))for(var i in e)this[i]=e[i];t.setMemoryLevel(this.general.memory)};var ArcConfig=ArcBaseObject();{var loaded=!1;function loadConfig(t){var e=this;loaded||$.ajax({dataType:"json",url:t,data:{},success:function(t){e.data=t,e.loaded=!0},error:function(t){console.error("Could not load configuration file.")},async:!1})}function splitName(t){return t.split(".")}ArcConfig.prototype.init=function(t){this.data=null,Object.defineProperty(this,"isLoaded",{get:function(){return loaded}}),this.data={},loadConfig.call(this,t)},ArcConfig.prototype.containsKey=function(t){for(var e=splitName(t),i=this.data,n=0;n<e.length;++n){if(!i.hasOwnProperty(e[n]))return!1;i=i[e[n]]}return!0},ArcConfig.prototype.getEntry=function(t){for(var e=splitName(t),i=this.data,n=0;n<e.length;++n){if(!i.hasOwnProperty(e[n]))return null;i=i[e[n]]}return i}}var ArcGame=ArcBaseObject();ArcGame.Current=null,ArcGame.prototype.init=function(t,e,i,n,r,o){void 0===r&&(r=60),e&&null!==e||(e=arcGetDisplayAdapter(t,o)),i&&null!==i||(i=arcGetControlAdapter(t)),n&&null!==n||(n=arcGetAudioAdapter()),this.display=e,this.control=i,this.audio=n,this.beginLoopListeners=[],this.endLoopListeners=[],this.updateListeners=[],this.drawListeners=[],this.frameCap=1e3/r,this.canvas=t;var a=1e3/r,s=Date.now()-a,c=s,h=0,p=0,u=0,l=0;ArcGame.Current=this,this.animate=function(){return u=Date.now(),h=u-s,(p=u-c)>a?(l=p%a,c=u-l,p-l):0},$(document).bind("focusin visibilitychange mozvisibilitychange webkitvisibilitychange msvisibilitychange",function(){c=Date.now()}),this.getPlayTime=function(){return h},this.resize(t.width,t.height)},ArcGame.prototype.setFrameCap=function(t){this.frameCap=1e3/t},ArcGame.prototype.resize=function(t,e){this.canvas.width=t,this.canvas.height=e,this.display.resize(t,e),this.onResize&&null!==this.onResize&&this.onResize(canvas.width,canvas.height)},ArcGame.prototype.setMemoryLevel=function(t){t<LEVEL_LOW?t=LEVEL_LOW:t>LEVEL_ULTRA&&(t=LEVEL_ULTRA),QuadTree.setMemoryLevel(t)},ArcGame.prototype.beginLoop=function(t){for(var e=0;e<this.beginLoopListeners.length;++e)this.beginLoopListeners[e](this,t)},ArcGame.prototype.endLoop=function(){for(var t=0;t<this.endLoopListeners.length;++t)this.endLoopListeners[t](this)},ArcGame.prototype.update=function(t){this.display.update(t);for(var e=0;e<this.updateListeners.length;++e)this.updateListeners[e](this,t)},ArcGame.prototype.draw=function(){for(var t=0;t<this.drawListeners.length;++t)this.drawListeners[t](this)},ArcGame.prototype.start=function(){var t=this,e=0,i=0,n=0,r=function(o){if(arcRequestAnimFrame(r),(e+=o-i)>=t.frameCap){for(n=0,t.beginLoop(e);e>=t.frameCap;)++n<10&&t.update(t.frameCap),e-=t.frameCap;t.draw(),t.endLoop()}i=o};r(0)};