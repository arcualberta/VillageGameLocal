var WORLD_SNAPSHOT=1,WORLD_ACTIONLIST=2,ACTION_ADD_USER=3,ACTION_MOVE_USER=4,ACTION_MODIFY_MAP=5,ACTION_REMOVE_USER=6,WORKER_DRAW_SCENE=1,WORKER_UPDATE_WORLD=2,WORKER_SEND_ACTION=3,WORKER_LOAD_IMAGE=4,WORKER_RESIZE=5,WORKER_SET_TILESHEET=6,WORKER_SET_PLAYER=7,WORKER_SET_WORLD=8,WORKER_SET_SPRITESHEET=9,WORKER_PASS_ACTION=10,WORKER_SET_MODEL=11,WORKER_LOAD_TASK_FUNCTION=12,WORKER_RUN_TASK_FUNCTION=13,WORKER_CLOSE_TASK_FUNCTION=14,WORKER_TRIGGER_TASK=15,WORKER_CALCULATE_DRAW=16,MAP_LOWER=1,MAP_MID=2,MAP_UPPER=3;var CharacterScripts=new ArcBaseObject;CharacterScripts.prototype=Object.create(ArcScriptObject.prototype),CharacterScripts.prototype.init=function(t){ArcScriptObject.prototype.init.call(this,t),this.AttachFunction("WalkRandom"),this.AttachFunction("WalkArea"),this.AttachFunction("InitializePath"),this.AttachFunction("UpdatePath")},CharacterScripts.prototype.WalkRandom=function(t,i,o){let a=this.waypoint,r=this.location;if(Math.random()<o)switch(Math.floor(4*Math.random())){case 0:a[0]=r[4],a[1]=r[5]+i;break;case 1:a[0]=r[4]+i,a[1]=r[5];break;case 2:a[0]=r[4],a[1]=r[5]-i;break;case 3:a[0]=r[4]-i,a[1]=r[5]}},CharacterScripts.prototype.WalkArea=function(t,i,o,a){let r=this.waypoint;this.location;(!this.lastStep[2]||Math.random()<.001)&&(r[0]=Math.random()*(o-t)+t,r[1]=Math.random()*(a-i)+i)},CharacterScripts.prototype.InitializePath=function(t,i=0,o=!1){t&&(this.path={name:t,point:i,reversed:o,pointBuffer:new Float32Array(2)},this.path.pointBuffer[0]=this.waypoint[0],this.path.pointBuffer[1]=this.waypoint[1],this.state="onfollowpath",this.onfollowpath=function(t,i,o,a){this.UpdatePath(o)})},CharacterScripts.prototype.UpdatePath=function(t){var i=this.path,o=t.objects.getChild(i.name);o&&(i.point>=o.pointCount?(i.point=o.pointCount-1,i.reversed=!i.reversed):i.point<=0&&(i.point=0,i.reversed=!i.reversed),o.getPoint(i.point,i.pointBuffer),this.waypoint[0]!=i.pointBuffer[0]||this.waypoint[1]!=i.pointBuffer[1]?(this.waypoint[0]=i.pointBuffer[0],this.waypoint[1]=i.pointBuffer[1]):this.lastStep[2]||(i.reversed?--i.point:++i.point))};var DialogScripts=new ArcBaseObject;DialogScripts.prototype=Object.create(ArcScriptObject.prototype),DialogScripts.prototype.init=function(t){ArcScriptObject.prototype.init.call(this,t),this.AttachFunction("TriggerDialog"),this.AttachFunction("TriggerTask")},DialogScripts.prototype.TriggerDialog=function(t,i,o,a){return i.showMessage(t,!1,o,this,a)},DialogScripts.prototype.TriggerTask=function(t,i,o){return i.loadTask(t,i.getTaskScript(t),o)};var Character=ArcBaseObject();{Character.prototype=Object.create(ArcCharacter.prototype),new CharacterScripts(Character.prototype),new DialogScripts(Character.prototype);function dot2D(t,i,e,o){return t*e+i*o}function comparePoint(t,i,e,o,a,r,n,s){var h=Math.sqrt(n*n+s*s);return h>=a&&h<=r&&(n/=h,s/=h,(h=dot2D(e,o,n,s))>0&&(h=1-h,e*s-o*n<0&&(h=-h),h>t&&h<i))?h:null}function evaluateViewAngle(t,i,e,o,a,r,n,s,h){if(t>i)return null;var c,l,p,d=s,u=h.players;for(var f in u)if(c=u[f],l=c.location[4]-a,p=c.location[5]-r,null!=comparePoint(t,i,e,o,n,d,l,p))return c;return null}function evaluateFOV(t){var i,e,o,a=1-Math.cos(this.fov.angle),r=this.fov.coneArray;switch(null==r&&(this.fov.coneArray=new Float32Array(12),(r=this.fov.coneArray)[2]=0,r[3]=.5,r[6]=1,r[7]=0,r[10]=1,r[11]=1),r[0]=this.location[4],r[1]=this.location[5],o=Math.tan(this.fov.angle)*this.fov.distance,this.direction){case 0:i=0,e=1,r[4]=-o+r[0],r[5]=this.fov.distance+r[1],r[8]=o+r[0],r[9]=this.fov.distance+r[1];break;case 1:i=-1,e=0,r[4]=-this.fov.distance+r[0],r[5]=-o+r[1],r[8]=-this.fov.distance+r[0],r[9]=o+r[1];break;case 2:i=0,e=-1,r[4]=-o+r[0],r[5]=-this.fov.distance+r[1],r[8]=o+r[0],r[9]=-this.fov.distance+r[1];break;default:i=1,e=0,r[4]=this.fov.distance+r[0],r[5]=-o+r[1],r[8]=this.fov.distance+r[0],r[9]=o+r[1]}var n=evaluateViewAngle(-a,a,i,e,this.location[4],this.location[5],0,this.fov.distance,t);n&&this.onsee?this.onsee(n,t):this.onnosee&&this.onnosee(n,t)}Character.VisionCone=new Image,Character.prototype.init=function(t,i){ArcCharacter.prototype.init.call(this),this.id=t,this.name=i;let e=new ArcRenderableText(i,{font:"bold 12px sans-serif",fillStyle:"yellow",textAlign:"center"});e.offset[1]=-12,this.addChild(e,"name"),this.lastStep=[0,0,!1],this.waypoint=[0,0],this.speed=.1,this.action=0,this.direction=0,this.blockable=!0,this.fov={enabled:!1,distance:300,angle:35*Math.PI/180,coneArray:null,color:new Float32Array(4)},this.updateSize(16,16)},Character.directions=["down","left","up","right"],Character.actions=["stand","walk"],Character.prototype.stop=function(){},Character.startBuffer=new Float32Array(2),Character.endBuffer=new Float32Array(2),Character.prototype.isOnGoal=function(t,i){var e=t.getClosestTileCoord(this.location[4],this.location[5],Character.startBuffer),o=t.getClosestTileCoord(i[0],i[1],Character.endBuffer);return Math.abs(e[0]-o[0])<1&&Math.abs(e[1]-o[1])<1},Character.prototype.calculateNextStep=function(t,i,e,o,a){if(this.isOnGoal(t,o))return a[0]=this.location[4],a[1]=this.location[5],a[2]=!1,a;var r=this.blockable,n=o[0]-this.location[4],s=o[1]-this.location[5],h=i*e/Math.sqrt(n*n+s*s),c=Math.round(n*h),l=Math.round(s*h),p=this.collisionBox();return c<0?r&&t.isBlocked(p[0]+c,p[1],p[0]+c+p[2],p[1]+p[3],p[2],p[3])&&(c=0):c>0&&r&&t.isBlocked(p[0]+c,p[1],p[0]+c+p[2],p[1]+p[3],p[2],p[3])&&(c=0),l<0?r&&t.isBlocked(p[0]+c,p[1]+l,p[0]+c+p[2],p[1]+p[3]+l,p[2],p[3])&&(l=0):l>0&&r&&t.isBlocked(p[0]+c,p[1]+l,p[0]+c+p[2],p[1]+p[3]+l,p[2],p[3])&&(l=0),0==c&&0==l||this.setMovementVector(c,l),a[0]=this.location[4]+c,a[1]=this.location[5]+l,a[2]=!0,a},Character.prototype.getSpriteSheet=function(t){var i=null;return(i=t.spriteSheets[this.spriteSheet.id])||t.addSpriteSheet(this.spriteSheet.id,this.spriteSheet.baseImage.src,this.spriteSheet.animations),i},Character.prototype.drawBounds=function(t){let i="#FF0",e=this.location[0],o=this.location[1],a=this.location[2],r=this.location[3];t.drawLine(e,o,e,r,i),t.drawLine(e,o,a,o,i),t.drawLine(a,r,e,r,i),t.drawLine(a,r,a,o,i),i="#F80",e=this.lastCollisionBox[0],o=this.lastCollisionBox[1],a=e+this.lastCollisionBox[2],r=o+this.lastCollisionBox[3],t.drawLine(e,o,e,r,i),t.drawLine(e,o,a,o,i),t.drawLine(a,r,e,r,i),t.drawLine(a,r,a,o,i)},Character.prototype.draw=function(t,i,e,o,a){var r=this.getSpriteSheet(t);if(this.fov.enabled&&this.fov.coneArray&&t.drawPolygon(this.fov.color,this.fov.coneArray,Character.VisionCone),r){var n=r.getAnimation(this.animation).frames[this.frame],s=this.location[4]-i,h=this.location[5]-n.hHalf-e;t.drawImage(r.image,n.x,n.y,n.width,n.height,s-n.wHalf,h,n.drawWidth,n.drawHeight),window.debugMode&&(this.getChild("name").draw(t,s,h,o,a),t.drawLine(this.waypoint[0],this.waypoint[1],this.location[4],this.location[5]),this.drawBounds(t))}},Character.prototype.updateAnimation=function(){this.setAnimation(Character.actions[this.action]+"_"+Character.directions[this.direction])},Character.prototype.tick=function(t,i,e){var o=this.calculateNextStep(e,this.speed,t,this.waypoint,this.lastStep),a=o[2];if(a){this.action=1;let t=this.movementVector[2];t>-ArcActor.MovementAngle.QUARTER?t<=ArcActor.MovementAngle.QUARTER?this.direction=3:t<=ArcActor.MovementAngle.THREE_QUARTER?this.direction=0:this.direction=1:t>=-ArcActor.MovementAngle.THREE_QUARTER?this.direction=2:this.direction=1,this.updateLocation(o[0],o[1])}else 1===this.action&&(this.action=0,a=!0);a?this.updateAnimation():this.showWaypoint=!1,this.animateFrame(t),parent.activeObject==this&&(parent.waypointLoc[0]=this.location[3]+this.size[2],parent.waypointLoc[1]=this.location[2]),this.fov.enabled&&evaluateFOV.call(this,e)}}var NPC=ArcBaseObject();Object.defineProperty(NPC,"isVillageObject",{enumerable:!1,configurable:!1,writable:!1,value:!0}),NPC.STATE=["idle","talk","path"],NPC.prototype=Object.create(Character.prototype),NPC.prototype.init=function(t,i,e,o,a,r){Character.prototype.init.call(this,t,t),this.properties=r,this.setState("idle"),this.clickEnabled=!0,this.interactEnabled=!0,this.spriteSheet=r.generated_map.getSpriteSheet(r.spritesheet);for(var n in r){"on"===n.substring(0,2)&&(this[n]=Function("time","player","world","worldAdapter",r[n]))}this.updateLocation(e[0],e[1]),this.waypoint[0]=e[0],this.waypoint[1]=this.location[1];var s=this.onstart;s&&s.call(this)},NPC.prototype.setState=function(t){this.state="on"+t},NPC.prototype.tick=function(t,i,e,o){var a=this[this.state];a&&a.call(this,t,o,e,i),Character.prototype.tick.apply(this,arguments)},NPC.prototype.click=function(t,i,e,o){e.activeObject=this;var a=this.onclick;a&&a.call(this,null,e,o)},NPC.prototype.interact=function(t,i,e,o,a,r,n){var s=this.oninteract;s&&s.call(this,null,a,r,n),a.activeObject===this&&((s=this.ontalk)&&s.call(this,null,a,r,n),a.activeObject=null)};var User=ArcBaseObject();User.prototype=Object.create(Character.prototype),User.prototype.init=function(t,i){Character.prototype.init.call(this,t,i)},User.prototype.tick=function(t){this.animateFrame(t)},User.prototype.draw=function(){Character.prototype.draw.apply(this,arguments)};var Teacher=ArcBaseObject();Teacher.prototype=Object.create(User.prototype);var Village=ArcBaseObject();Village.prototype.init=function(t){this.name=t,this.teachers={},this.students={},this.tileSheet=null,this.width=100,this.height=100,this.tileWidth=16,this.tileHeight=16,this.lowerMap=[],this.midMap=[],this.upperMap=[]},Village.prototype.getClosestTileCoord=function(t,i){return[Math.round(t/this.tileWidth),Math.round(i/this.tileHeight)]},Village.prototype.isBlocked=function(t,i,e,o,a,r){if(null!==this.tileSheet){var n=t/this.tileWidth,s=i/this.tileHeight,h=Math.ceil(n+a/this.tileWidth),c=Math.ceil(s+r/this.tileHeight);n=Math.floor(n);for(var l=s=Math.floor(s);l<c;++l)for(var p=n;p<h;++p){var d=p+l*this.width;if(d>0&&d<this.lowerMap.length){var u=this.lowerMap[d];if(u>-1&&!this.tileSheet.tiles[u].walkable)return!0;if((u=this.midMap[d])>-1&&!this.tileSheet.tiles[u].walkable)return!0}}return!1}return!0};var Student=ArcBaseObject();Student.prototype=Object.create(User.prototype),Student.prototype.init=function(t,i,e){User.prototype.init.call(this,t,i),this.level=1,this.exp=0,e&&null!==e&&(e.students[""+t]=this)};var Player=ArcBaseObject();Player.prototype.init=function(t){this.user=t,this.showWaypoint=!1,this.waypointLoc=[t.location[0],t.location[1]],this.speed=.24,this.direction=0,this.action=0,this.lastStep=[0,0,!1],this.activeObject=null,this.stats={}},Player.prototype.stop=function(){this.user.stop()},Player.prototype.tick=function(t,i,e){var o=this.user,a=o.calculateNextStep(e,this.speed,t,this.waypointLoc,this.lastStep),r=a[2];if(r){this.action=1;let t=this.user.movementVector[2];t>-ArcActor.MovementAngle.QUARTER?t<=ArcActor.MovementAngle.QUARTER?this.direction=3:t<=ArcActor.MovementAngle.THREE_QUARTER?this.direction=0:this.direction=1:t>=-ArcActor.MovementAngle.THREE_QUARTER?this.direction=2:this.direction=1,o.updateLocation(a[0],a[1]);var n=o.collisionBox();e.interact(n[0],n[1],n[0]+n[2],n[1]+n[3],this,e,i)}else 1===this.action&&(this.action=0,r=!0);r?(o.setAnimation(Character.actions[this.action]+"_"+Character.directions[this.direction]),i.postWorldActions({timestamp:Date.now(),action:{type:ACTION_MOVE_USER,user:{id:o.id,name:o.name,location:[o.location[0],o.location[1]],animation:o.animation}}})):this.showWaypoint=!1,o.waypoint[0]=this.waypointLoc[0],o.waypoint[1]=this.waypointLoc[1]};var Path=ArcBaseObject();Object.defineProperty(Path,"isVillageObject",{enumerable:!1,configurable:!1,writable:!1,value:!0}),Path.prototype=Object.create(ArcActor.prototype);{function splitLineString(t,e){if(t){var o,a=t.split(" ");for(this.pointCount=a.length,this.points=new Float32Array(this.pointCount<<1),i=0;i<a.length;++i)o=a[i].split(","),this.points[i<<1]=parseFloat(o[0])*e,this.points[1+(i<<1)]=parseFloat(o[1])*e}else this.pointCount=0,this.points=new Float32Array(0)}Path.prototype.init=function(t,i,e,o,a,r,n){ArcActor.prototype.init.call(this,!0,!0,!1),this.name=t,this.type=i,this.pointCount=0,this.centre=[e[0]+o[0]/2,e[1]+o[1]/2],this.updateSize(o[0],o[1]),this.updateLocation(e[0],e[1]),splitLineString.call(this,n.find("polyline").attr("points"),r.generated_scale);for(var s in r){"on"===s.substring(0,2)&&(this[s]=Function("time","player","world","worldAdapter",r[s]))}this.ontick||(tickEnabled=!1),this.onstart&&this.onstart(0,null,null,null)},Path.prototype.tick=function(t,i,e){var o=this.ontick;o&&o.call(this,t,i,e)},Path.prototype.getPoint=function(t,i){if(t<0||t>=this.pointCount)return null;var e=t<<1;return i[0]=this.points[e]+this.location[0],i[1]=this.points[e+1]+this.location[1],i},Path.prototype.draw=function(t,i,e,o,a){if(window.debugMode&&this.pointCount>1){let i=this.points[0]+this.location[0],e=this.points[1]+this.location[1];for(var r=2;r<this.points.length;++r){let o=this.points[r]+this.location[0];++r;let a=this.points[r]+this.location[1];t.drawLine(i,e,o,a,"#0FF"),i=o,e=a}}}}var WorldAdapter=ArcBaseObject();WorldAdapter.prototype.init=function(t,i,e){this.responseFunction=t,this.messageFunction=i},WorldAdapter.prototype.login=function(t){return{isSuccessful:!0}},WorldAdapter.prototype.logout=function(t){},WorldAdapter.prototype.requestWorldState=function(t){},WorldAdapter.prototype.getWorldActions=function(t){},WorldAdapter.prototype.postWorldActions=function(t){},WorldAdapter.prototype.getSpriteSheet=function(t){},WorldAdapter.prototype.removeUserFromMap=function(t){postWorldActions([{timestamp:Date.now(),action:{type:ACTION_REMOVE_USER,user:{id:t}}}])},WorldAdapter.prototype.showMessage=function(t,i,e,o,a){console.log(t),a()};function GameMenu(e,t,n,a,i){var r=this,o=$("<div></div>");if(a&&null!==a&&o.css("background-image","url("+a+")"),o.addClass("game_dialogWindow"),o.css("width",t+"px"),o.css("height",n+"px"),o.hide(),i&&"string"==typeof i)for(var s=i.split(" "),l=0;l<s.length;++l)o.addClass(s[l]);var c=$("<div></div>");c.addClass("game_dialogTitleBar"),c.text(e),o.append(c),this.titleBar=c,this.body=$("<div></div>"),this.body.addClass("game_dialogBody"),o.append(this.body),this.show=function(e){o.css("left",e.offsetLeft+(e.width-t>>1)+"px"),o.css("top",e.offsetTop+(e.height-n>>1)+"px"),$(e).parent().append(o),o.show("fast",function(){r.onresize&&r.onresize()})},this.close=function(){o.hide("fast",function(){o.remove(),r.closeComplete()})},this.closeComplete=function(){},this.handleActions=function(e){},this.animate=function(e){},this.setTitle=function(e){c.text(e)}}function LoginMenu(e){var t=new GameMenu("Login",300,400,!1,"login_menu"),n=$("<input type='text' name='passcode' class='game_center passcode_input'></input>"),a=$("<button class='game_center login_button'>Login</button>");return t.body.append($("<h3 class='game_center passcode_title'>Passcode</h3>")),t.body.append(n),t.body.append(a),t.userId=null,t.username=null,n.keypress(function(e){if(13===(e.keyCode||e.which))return e.preventDefault(),a.click(),!1}),a.click(function(){var a=e(n.val());a.isSuccessful&&(t.userId=a.userId,t.userName=a.userName,t.close())}),t}function setPaletteColor(e,t,n,a){var i=basePalette[e];i&&(i.r=Math.min(Math.round(t),255),i.g=Math.min(Math.round(n),255),i.b=Math.min(Math.round(a),255))}function CharacterSelectMenu(e){function t(e,t,n,a,r,o){setPaletteColor(a,2*e,2*t,1.8*n),setPaletteColor(r,e,t,n),setPaletteColor(o,.7*e,.75*t,.8*n);for(var s in i.sprites)i.sprites[s].updateColorset()}function n(e,n,a,i,r){e.click(function(o){e.parent().find(".color_select.active").removeClass("active"),e.addClass("active"),t(r.r,r.g,r.b,n,a,i)})}function a(e,t,a,i){for(var r=$("<div class='color_select_div'></div>"),o=0;o<i.length;++o){var s=i[o],l=$("<div class='color_select'></div>");l.css("background-color","rgb("+s.r+", "+s.g+", "+s.b+")"),n(l,e,t,a,s),r.append(l)}f.append(r)}var i=new GameMenu("Character Select",332,330);i.sprites=[],i.selected=0;var r=["down","up","left","right"],o=0;for(var s in e){var l=e[s];l.setPalette(basePalette),i.sprites.push(l)}var c=0,u=0,d=5e3,g=$("<button class='button_left'>&lt;</button>"),p=$("<button class='button_right'>&gt;</button>"),b=$("<canvas style='background-color: rgba(0, 0, 0, 0);' width='80' height='120'></canvas>"),v=$("<button>Select</button>"),m=$("<button>Random</button>"),h=$("<div class='game_left'></div>");i.body.append(h),h.append(g),h.append(b),h.append(p);var f=$("<div class='game_right'></div>");i.body.append(f),h=$("<div class='game_center' style='width: 320px; float: left;'></div>"),i.body.append(h),h.append(v),h.append(m),g.click(function(){var e=i.selected-1;e<0&&(e=i.sprites.length+e),i.selected=e}),p.click(function(){var e=i.selected+1;e>=i.sprites.length&&(e-=i.sprites.length),i.selected=e}),v.click(function(){var e=i.sprites[i.selected];i.characterSelected(e),i.close()}),m.click(function(){$(f).find(".color_select_div").each(function(){var e=$(this).find(".color_select"),t=Math.min(Math.round(Math.random()*e.length),e.length-1);$(e[t]).click()})}),a(16777088,16776960,8421376,[{r:213,g:236,b:231},{r:239,g:231,b:143},{r:153,g:229,b:130},{r:130,g:229,b:188},{r:61,g:68,b:219},{r:167,g:93,b:21},{r:70,g:47,b:24},{r:54,g:54,b:54}]),a(16760960,16744448,8404992,[{r:235,g:220,b:206},{r:218,g:197,b:150},{r:212,g:130,b:92},{r:163,g:107,b:92},{r:80,g:85,b:114},{r:120,g:137,b:141},{r:109,g:94,b:105},{r:78,g:75,b:68},{r:54,g:54,b:54}]),a(16777215,13816530,8421504,[{r:248,g:213,b:194},{r:239,g:187,b:166},{r:230,g:170,b:134},{r:210,g:148,b:107},{r:197,g:143,b:99},{r:132,g:87,b:54},{r:113,g:80,b:49},{r:136,g:86,b:59}]);var k=[{r:230,g:230,b:230},{r:229,g:15,b:15},{r:244,g:115,b:29},{r:248,g:228,b:9},{r:29,g:181,b:9},{r:9,g:181,b:163},{r:36,g:93,b:222},{r:137,g:36,b:222},{r:54,g:54,b:54}];a(16744576,16711680,8388608,k),a(8454016,65280,32768,k),a(8421631,255,128,k),m.click(),r=["down","left","up","right"];var _=b[0].getContext("2d");return _.imageSmoothingEnabled=!1,i.animate=function(e){var t=i.sprites[i.selected].animations["walk_"+r[o]].frames,n=t[c];for(u+=e;u>n.frameTime;)++c>=t.length&&(c=0),u-=n.frameTime,n=t[c];(d-=e)<0&&(d=5e3,++o>3&&(o=0,c=0,u=0)),_.clearRect(0,0,80,120),_.drawImage(i.sprites[i.selected].image,n.x,n.y,n.width,n.height,0,0,80,120)},i.characterSelected=function(e){},i}function SettingsWindow(e){var t=new GameMenu("",300,200),n=$("<div class='dialog_menu'></div>");t.body.append(n);var a=function(e,t,n){var a=$("<li></li>");a.append($("<span class='menu-label'></span>").text(t)),a.append($("<span class='menu-content'></span>").append(n)),e.append(a)},i=function(e,t,n,i,r,o,s){var l=$("<input></input>");l.attr("type","range"),l.attr("min",i),l.attr("max",r),l.attr("step",o),l.attr("value",n),l.bind("change",function(e){recordEvent("Settings","SetValue",t,this.value),s.apply(this,arguments)}),a(e,t,l)},r=function(e,t,n,i,r){for(var o=t.replace(/\s/g,""),s=$("<div></div>"),l=0;l<i.length;++l){var c=$("<input></input>");c.attr("type","radio"),c.attr("name",o),c.attr("value",i[l][0]),c.css("width","auto"),s.append(c),i[l][0]==n&&(c[0].checked=!0);var u=$("<span></span>");u.text(i[l][1]),s.append(u),c.change(function(){this.checked&&(recordEvent("Settings","SetValue",t,this.value),r.apply(this,arguments))})}a(e,t,s)},o=function(e,t,n){var a=$("<li></li>").text(t);a.click(function(){l(n)}),e.append(a)},s=function(e,t,n){for(var a,i=$("<div class='game_center' style='width: 320px; float: left;'></div>"),r=0;r<t.length;++r)(a=$("<button></button>")).text(t[r]),a.click(n[r]),i.append(a);e.append(i)},l=function(a){n.empty();var c=$("<ul class='game_center'></ul>");switch(n.append(c),a){case 1:t.titleBar.text("General Settings"),r(c,"Memory Usage",ArcSettings.Current.general.memory,[[LEVEL_LOW,"Low"],[LEVEL_MED,"Medium"],[LEVEL_HIGH,"High"],[LEVEL_ULTRA,"Ultra"]],function(){e.setMemoryLevel(this.value),ArcSettings.Current.general.memory=this.value}),s(n,["Back"],[function(){l(0)}]);break;case 2:t.titleBar.text("Sound Settings"),i(c,"Volume",100*e.audio.getVolume(),0,100,1,function(){e.audio.setVolume(this.value/100),console.log(e.audio.getVolume())}),s(n,["Back"],[function(){l(0)}]);break;case 3:t.titleBar.text("Video Settings"),s(n,["Back"],[function(){l(0)}]);break;default:t.titleBar.text("Settings"),o(c,"General",1),o(c,"Sound",2),o(c,"Video",3),s(n,["Close"],[function(){ArcSettings.Current.save(e),t.close()}])}};return l(0),t}function DialogMenu(dialog,name,lineNumber,player,speaker){var menu=new GameMenu("",500,200),currentLine=null,optionLabels=["A) ","B) ","C) "];menu.variables={player:player,speaker:speaker};var dialogSection=$("<div class='dialog_text'></div>");menu.body.append(dialogSection);var createOptionClick=function(e){return function(t){recordEvent("Dialog","SelectOption",name+" - "+currentLine.LINE_NUMBER,e),setLine(name,currentLine["OPTION_"+e+"_LINE"]),t.stopImmediatePropagation()}},setLine=function(name,lineNumber){recordEvent("Dialog","SetLine",name,lineNumber),dialog.getDialog(name,lineNumber,function(result){null===result&&(console.log("Error loading dialog: "+name+" - "+lineNumber),menu.close());let player=menu.variables.player,speaker=menu.variables.speaker;result.ON_OPEN&&eval(result.ON_OPEN),dialogSection.empty();var message=$("<h3></h3>");message.text(eval("`"+result.MESSAGE+"`")),dialogSection.append(message);for(var i=1;i<4;++i)if(result["OPTION_"+i]){var option=$("<h4 class='dialog_option'></h4>");option.text(optionLabels[i-1]+result["OPTION_"+i]),option.click(createOptionClick(i)),dialogSection.append(option)}menu.titleBar.text(result.CHARACTER),currentLine=result})};return dialogSection.click(function(e){null===currentLine&&menu.close(),null!==currentLine.OPTION_1||(null!==currentLine.NEXT_LINE?setLine(name,currentLine.NEXT_LINE):menu.close())}),setLine(name,lineNumber),menu}function TaskMenu(e,t,n){var a=new GameMenu(e,t,n);return a.canvas=$("<canvas style='background-color: rgba(0, 0, 0, 0);' width='"+t+"' height='"+(n-50)+"'></canvas>")[0],a.task=null,a.body.append(a.canvas),a.animate=function(e){if(null!=a.task){let t=a.task;a.task.update(e),a.task.draw(t.displayAdapter,t.drawModel)}},a.onresize=function(){a.task.resize(a.body.innerWidth(),a.body.innerHeight())},a}var basePalette={16777215:{r:255,g:255,b:255},13816530:{r:210,g:210,b:210},8421504:{r:128,g:128,b:128},16760960:{r:255,g:192,b:128},16744448:{r:255,g:128,b:128},8404992:{r:128,g:64,b:0},16744576:{r:255,g:128,b:128},16711680:{r:255,g:0,b:0},8388608:{r:128,g:0,b:0},8454016:{r:128,g:255,b:128},65280:{r:0,g:255,b:0},32768:{r:0,g:128,b:0},8421631:{r:128,g:128,b:255},255:{r:0,g:0,b:255},128:{r:0,g:0,b:128},16777088:{r:255,g:255,b:255},16776960:{r:0,g:0,b:255},8421376:{r:0,g:0,b:128}};function TileView(t,e,i,a,r,n,s){var o=this;this.x=e,this.y=i,this.width=a,this.height=r,this.image=t;var h=document.createElement("canvas");h.width=n,h.height=s,this.canvas=h;var l=document.getElementsByTagName("script"),c=l[l.length-1];c.parentNode.insertBefore(h,c);var p,d=function(){p.fillStyle="violet",p.fillRect(0,0,n,s),p.drawImage(o.image,o.x,o.y,o.width,o.height,0,0,n,s)};this.update=function(){p=h.getContext("2d"),d()},this.updateTile=function(t,e,i,a){o.x=t,o.y=e,o.tileWidth=i,o.update()},this.update()}function TileSelector(t,e,i,a){var r=this;this.image=null,this.tileWidth=t,this.tileHeight=e,this.outputCanvas=null;var n=[0,0],s=document.createElement("canvas");s.width=i,s.height=a;var o=document.getElementsByTagName("script"),h=o[o.length-1],l=$("<div style='overflow: scroll; width: "+i+"px; height: "+a+"px;'></div>");l.append(s),h.parentNode.insertBefore(l[0],h);var c=s.getContext("2d"),p=function(){if(null!=r.image&&(c.drawImage(r.image,0,0),c.strokeStyle="white",c.lineWidth=1,c.strokeRect(n[0],n[1],r.tileWidth,r.tileHeight),null!=r.outputCanvas)){var t=r.outputCanvas.getContext("2d");t.fillStyle="violet",t.fillRect(0,0,r.outputCanvas.width,r.outputCanvas.height),t.drawImage(r.image,n[0],n[1],r.tileWidth,r.tileHeight,0,0,r.outputCanvas.width,r.outputCanvas.height)}};this.getTile=function(){return{x:n[0],y:n[1],width:r.tileWidth,height:r.tileHeight}},this.selectTile=function(t,e){n[0]=Math.floor(t/r.tileWidth)*r.tileWidth,n[1]=Math.floor(e/r.tileHeight)*r.tileHeight,r.onchange&&null!=r.onchange&&r.onchange()},this.onchange=null;var d=!1;s.onmousedown=function(t){d=!0;var e=t.pageX-s.offsetLeft+l.scrollLeft(),i=t.pageY-s.offsetTop+l.scrollTop();r.selectTile(e,i)},s.onmouseup=function(t){d=!1},s.onmousemove=function(t){if(d){var e=t.pageX-s.offsetLeft+l.scrollLeft(),i=t.pageY-s.offsetTop+l.scrollTop();r.selectTile(e,i)}},s.onmouseout=function(t){d=!1},setInterval(function(){null!=r.image&&(r.image.width==s.width&&r.image.height==s.height||(s.width=r.image.width,s.height=r.image.height,c=s.getContext("2d"))),p()},300)}function stringifyMapLayer(t){return JSON.stringify(t)}function parseMapLayer(t){var e=JSON.parse(t),i=[];for(var a in e)i[parseInt(a)]=e[a];return i}function drawToCanvas(t,e){var i=t.getContext("2d"),a=t.width>t.height?t.width:t.height,r=a/e.width,n=a/e.height,s=parseMapLayer(e.lowerMap),o=parseMapLayer(e.midMap),h=parseMapLayer(e.upperMap),l=new Image;l.onload=function(){for(var t=0,a=0;a<e.height;++a)for(var c=0;c<e.width;++c){var p=null,d=s[t];d>=0&&(p=e.tileSheet.tiles[d],i.drawImage(l,p.x,p.y,p.width,p.height,c*r,a*n,r,n)),(d=o[t])>=0&&(p=e.tileSheet.tiles[d],i.drawImage(l,p.x,p.y,p.width,p.height,c*r,a*n,r,n)),(d=h[t])>=0&&(p=e.tileSheet.tiles[d],i.drawImage(l,p.x,p.y,p.width,p.height,c*r,a*n,r,n)),++t}},l.src=e.tileSheet.imageUrl}function createMapCanvas(t,e,i){var a=document.getElementsByTagName("script"),r=a[a.length-1],n=document.createElement("canvas");return n.width=t,n.height=t,r.parentNode.insertBefore(n,r),i&&null!=i&&drawToCanvas(n,i),n}function TileSheetScript(){this.MAP_SMALL=[100,100],this.MAP_MEDIUM=[200,200],this.MAP_LARGE=[300,300],this.lower=[],this.mid=[],this.upper=[],this.dimension=[0,0],this.tileDimension=[16,16],this.tiles=[];var t=this;this.getTileIndexByName=function(e){for(var i in t.tiles)if(t.tiles[i].name===e)return i;return-1},this.setTile=function(e,i,a,r){if(!(i<0||i>=t.dimension[0]||a<0||a>=t.dimension[1])){var n=r;"string"==typeof r&&(n=t.getTileIndexByName(r));var s=i+a*t.dimension[0];switch(e){case MAP_LOWER:t.lower[s]=n;break;case MAP_MID:t.mid[s]=n;break;case MAP_UPPER:t.upper[s]=n}}},this.randomWorld=function(e,i,a,r,n){var s=n[0]*n[1];t.dimension=n,t.lower=new Int16Array(s),t.mid=new Int16Array(s),t.upper=new Int16Array(s),t.tiles=i.tiles;for(var o=0,h=0;h<n[1];++h)for(var l=0;l<n[0];++l)t.lower[o]=-1,t.mid[o]=-1,t.upper[o]=-1,++o;t.blankWorld(n[0],n[1]);t.createMayorsHouse(n[0],n[1]),t.createStudentHouses(r,n[0],n[1]);var c=new Village(e);return c.tileSheet=i,c.width=this.dimension[0],c.height=this.dimension[1],c.tileWidth=this.tileDimension[0],c.tileHeight=this.tileDimension[1],c.lowerMap=stringifyMapLayer(this.lower),c.midMap=stringifyMapLayer(this.mid),c.upperMap=stringifyMapLayer(this.upper),c}}var TaskScript=ArcBaseObject();TaskScript.prototype.init=function(canvas,title,scriptLocation,resourcePath,worker){var __this=this;this.displayAdapter=null,this.controlAdapter=arcGetControlAdapter(canvas),this.model={state:0},this.resourcePath=resourcePath,this.title=title,$.ajax({url:scriptLocation,dataType:"text",cache:!1,success:function(data){var fn,object;data=data.replace(/\/\*.+?\*\/|\/\/.*(?=[\n\r])/g,"");try{fn=eval(data),object=fn(__this,resourcePath)}catch(t){var err=t.constructor("Error loading task script: "+t.message);throw err.lineNumber=t.lineNumber-err.lineNumber+3,err}__this.displayAdapter=arcGetDisplayAdapter(canvas,object.allowGL),__this.resize(canvas.width,canvas.height)},async:!1})},TaskScript.prototype.resize=function(t,e){},TaskScript.prototype.draw=function(){},TaskScript.prototype.done=function(){},TaskScript.prototype.reward=function(){return null},TaskScript.prototype.update=function(t){},TaskScript.prototype.close=function(){};var HousingSection=ArcBaseObject();HousingSection.prototype.init=function(t,i,e,a,r,n,o,s,l){var h=this;if(this.name=t,this.location=new Float32Array([Math.floor(i/n),Math.floor(e/o),Math.round(a/n),Math.round(r/o)]),this.housingCode=[],this.bins=new Uint8Array(this.location[2]*this.location[3]),this.nextHouse=0,l)for(var c=l.split(","),p=0;p<c.length;++p)$.get(s+c+".tmx",function(t){var i=null;"string"==typeof t&&(t=$.parseXML(t)),i=$(t.children[0]),h.housingCode=i})},HousingSection.prototype.canFitInBin=function(t,i,e,a){return!0},HousingSection.prototype.addHouse=function(t,i,e){if(0!==this.housingCode.length){for(var a,r=this,n=this.location[2],o=this.location[3],s=!0,l=0,h=-1,c=0,p=$(this.housingCode[0]),d=parseInt(p.attr("width")),g=parseInt(p.attr("height"));h<o&&s;)for(++h,l=0;l<n;){if(0===(a=this.bins[c])){if(this.canFitInBin(h,l,d,g)){s=!1;break}a=1}c+=a,l+=a}return s||(c=0,s=!1,l+=r.location[0],h+=r.location[1],p.children().each(function(){var i=this.localName,e=$(this).attr("name");if("layer"===i){for(var a=s?t.highLayers[c]:t.lowLayers[c],r=$(this).find("data").text().split(","),n=0,o=0,p=0;p<r.length;++p)0!=r[p]&&(n=Math.floor(p/d),o=p%d,n+=h,o+=l,a.setTile(o,n,parseInt(r[p])-1));++c}else"objectgroup"===i&&("triggers"===e||"objects"===e&&(c=0,s=!0))})),!1}};var VillageObject=ArcBaseObject();VillageObject.prototype=Object.create(ArcActor.prototype),Object.defineProperty(VillageObject,"isVillageObject",{enumerable:!1,configurable:!1,writable:!1,value:!0}),new DialogScripts(VillageObject.prototype),VillageObject.prototype.init=function(t,i,e,a,r,n){ArcActor.prototype.init.call(this,!0,!0,!1),this.name=t,this.properties={},this.tileId=n.generated_tileId,this.centre=[e[0]+a[0]/2,e[1]+a[1]/2],this.rotation=r,this.type=i,this.parameters=n,this.clickEnabled=!0,this.interactEnabled=!0,this.updateSize(a[0],a[1]),this.updateLocation(e[0],e[1]);for(var o in n){"on"===o.substring(0,2)&&(this[o]=Function("time","player","world","worldAdapter",n[o]))}this.onstart&&this.onstart(0,null,null,null)},VillageObject.prototype.draw=function(t,i,e,a,r){this.parameters.visible&&t.drawTileById(this.tileId,this.location[0]-i,this.location[1]-e,this.size[0],this.size[1]),window.debugMode&&(t.drawLine(this.location[0],this.location[1],this.location[0],this.location[3],"#F00"),t.drawLine(this.location[0],this.location[1],this.location[2],this.location[1],"#F00"),t.drawLine(this.location[2],this.location[3],this.location[0],this.location[3],"#F00"),t.drawLine(this.location[2],this.location[3],this.location[2],this.location[1],"#F00"))},VillageObject.prototype.click=function(t,i,e,a){e.activeObject=this;var r=this.onclick;r&&r.call(this,null,e,a)},VillageObject.prototype.interact=function(t,i,e,a,r,n,o){var s=this.onwalk;s&&s.call(this,null,r,n,o),r.activeObject===this&&((s=this.oninteract)&&s.call(this,null,r,n,o),r.activeObject=null)},VillageObject.prototype.tick=function(t,i,e,a){var r=this.onidle;r&&r.call(this,t,a,e,i),ArcActor.prototype.tick.apply(this,arguments)};var PlayerStart=ArcBaseObject();PlayerStart.prototype=Object.create(VillageObject.prototype),Object.defineProperty(PlayerStart,"isVillageObject",{enumerable:!1,configurable:!1,writable:!1,value:!0});var ScriptTrigger=ArcBaseObject();ScriptTrigger.prototype=Object.create(ArcTrigger.prototype),ScriptTrigger.prototype.init=function(t,i,e,a,r,n,o){ArcTrigger.prototype.init.call(this,t,i,e,a,r),this.clickEnabled=!1,this.interactEnabled=!1;for(var s in n){"on"===s.substring(0,2)&&(this[s]=Function("time","player","world","worldAdapter","modulePath",n[s]))}this.onstart&&this.onstart(0,null,null,null,o)},ScriptTrigger.prototype.interact=function(t,i,e,a,r,n,o){this.oninteract&&this.oninteract(0,r,n,o)},ScriptTrigger.prototype.click=function(t,i,e,a){this.onclick&&this.onclick(0,e,a,null)};var ChangeMapTrigger=ArcBaseObject();ChangeMapTrigger.prototype=Object.create(ArcTrigger.prototype),ChangeMapTrigger.prototype.init=function(t,i,e,a,r,n,o,s){ArcTrigger.prototype.init.call(this,t,i,e,a,r),this.module=n,this.mapName=o,this.start=s},ChangeMapTrigger.prototype.interact=function(t,i,e,a,r,n,o){this.module.load(this.mapName,this.start)};var ClickReadTrigger=ArcBaseObject();ClickReadTrigger.prototype=Object.create(ArcTrigger.prototype),ClickReadTrigger.prototype.init=function(t,i,e,a,r,n,o){ArcTrigger.prototype.init.call(this,t,i,e,a,r),this.message=n,this.connectedObject=o,this.activated=!1,this.clickEnabled=!0},ClickReadTrigger.prototype.click=function(t,i,e,a){e.showWaypoint=!1,e.waypointLoc[0]=this.centre[0],e.waypointLoc[1]=this.centre[1],e.activeObject=this},ClickReadTrigger.prototype.interact=function(t,i,e,a,r,n,o){if(r.activeObject==this){var s=this;this.activated||r.waypointLoc[0]!==this.centre[0]||r.waypointLoc[1]!==this.centre[1]||(this.activated=!0,r.stop(),o.showMessage(this.message,!1,r,this,function(){s.activated=!1,r.activeObject=null}))}};var ClickTaskTrigger=ArcBaseObject();ClickTaskTrigger.prototype=Object.create(ArcTrigger.prototype),ClickTaskTrigger.prototype.init=function(t,i,e,a,r,n,o){ArcTrigger.prototype.init.call(this,t,i,e,a,r),this.task=o,this.title=n,this.activated=!1,this.clickEnabled=!0},ClickTaskTrigger.prototype.click=function(t,i,e,a){e.showWaypoint=!1,e.waypointLoc[0]=this.centre[0],e.waypointLoc[1]=this.centre[1],e.activeObject=this},ClickTaskTrigger.prototype.interact=function(t,i,e,a,r,n,o){if(r.activeObject==this){var s=this;this.activated||r.waypointLoc[0]!==this.centre[0]||r.waypointLoc[1]!==this.centre[1]||(this.activated=!0,o.loadTask(this.task,o.getTaskScript(this.task),function(t){s.activated=!1,r.activeObject=null}))}};var ArcBackgroundMusicTrigger=ArcBaseObject();ArcBackgroundMusicTrigger.prototype=Object.create(ArcTrigger.prototype),ArcBackgroundMusicTrigger.prototype.init=function(t,i,e,a,r,n,o){ArcTrigger.prototype.init.call(this,t,i,e,a,r),this.audio=o,this.sound=new ArcSound(t,!0,n),this.isPlaying=!1,this.fade=100,this.audio.loadSound(this.sound,!1,function(t){console.log("Error loading sound: "+n)})},ArcBackgroundMusicTrigger.prototype.interact=function(t,i,e,a,r,n,o){this.inLocation(t,i,e,a)&&o.module.setBackgroundMusic(this.sound,this.fade)};var VillageMap=ArcBaseObject();VillageMap.prototype=Object.create(ArcMap.prototype),VillageMap.prototype.init=function(t,i,e){ArcMap.prototype.init.call(this,t,i),this.housingSections=[],this.studentList=[{id:721,name:"Demo Student"}],this.waypointIndex=0,this.players={},this.waypoint=new ArcWaypoint,this.triggers=null,this.objects=null,this.neighbors=[null,null,null,null]},VillageMap.prototype.addPlayer=function(t){this.players[t.id]=t,this.objects&&null==this.objects.getChild(t.name)&&this.objects.insert(t)},VillageMap.prototype.setWaypointLocation=function(t){let i=this.waypoint;null!==t?(i.isVisible=!0,i.location[0]=t[0],i.location[1]=t[1]):i.isVisible=!1},VillageMap.prototype.cast=function(){var t=new VillageMap(this.name);for(var i in this)t[i]=this[i];return t},VillageMap.prototype.getSpriteSheet=function(t){return this.parent.getSpriteSheet(t)},VillageMap.prototype.addTrigger=function(t,i,e,a,r){var n=t.attr("name"),o=t.attr("type").toLowerCase(),s=Number(t.attr("x"))*i,l=Number(t.attr("y"))*i,h=Number(t.attr("width"))*i,c=Number(t.attr("height"))*i,p={},d=null;t.find("properties > property").each(function(){p[$(this).attr("name").toLowerCase()]=$(this).attr("value")?$(this).attr("value"):$(this).text()}),d="changemap"===o?new ChangeMapTrigger(n,o,[s,l],[h,c],0,this.parent,p.map,p.start):"clickread"===o?new ClickReadTrigger(n,o,[s,l],[h,c],0,p.message,p.object):"clicktask"===o?new ClickTaskTrigger(n,o,[s,l],[h,c],0,p.title,p.task):"backgroundmusic"===o?new ArcBackgroundMusicTrigger(n,o,[s,l],[h,c],0,a+"/"+p.file,r.audio):"script"===o?new ScriptTrigger(n,o,[s,l],[h,c],0,p,a):new ArcTrigger(n,o,[s,l],[h,c],0),p.follow&&(d.followObject=p.follow),e.insert(d)},VillageMap.prototype.getObject=function(t,i=!1){return this.objects.findChild(t)},VillageMap.prototype.load=function(t,i,e){if(this.loaded){var a=[0,0];if(i){var r=this.objects.getByName(i);null!==r&&(a=r.centre.slice())}return this.loaded=!0,void(t&&null!==t&&t(this,a))}var n=this.parent.path,o=this;$.get(n+"/maps/"+this.name+".tmx",function(a){var r=null;"string"==typeof a&&(a=$.parseXML(a)),r=$(a.children[0]),o.width=parseInt(r.attr("width")),o.height=parseInt(r.attr("height")),o.tileWidth=2*parseInt(r.attr("tilewidth")),o.tileHeight=2*parseInt(r.attr("tileheight"));var s=o.tiles,l=function(t,i,e,a,r,n){if(i<t.firstGid)return null;if(s[i])return s[i];var o=i-t.firstGid,l=Math.floor(e/a),h=Math.floor(o/l),c=o-h*l;return c*=a,h*=r,s[i]=new ArcTile(c,h,a,r,!0,!1,i),s[i].tileSheetName=t.name,s[i]},h=function(t,i,e,a,r,n){var o=new ArcAnimation;return n.each(function(){var t=parseInt($(this).attr("duration")),i=parseInt($(this).attr("tileid")),n=Math.floor(e/a),s=Math.floor(i/n),l=i-s*n;l*=a,s*=r,o.addFrame(l,s,a,r,t,!1,!1)}),s[i]=new ArcAnimatedTile(o,!0,!1,i),s[i].tileSheetName=t.name,s[i]};r.find("tileset").each(function(){var t=$(this),i=parseInt(t.attr("firstgid"))-1;!t.attr("name")&&t.attr("source")&&$.ajax({url:n+"/maps/"+t.attr("source"),method:"GET",success:function(i){t=$($.parseXML(i)).children()},async:!1});var e=parseInt(t.attr("tilewidth")),a=parseInt(t.attr("tileheight")),r=t.find("image"),c=parseInt(r.attr("width")),p=new ArcTileSheet(t.attr("name"),n+"/maps/"+r.attr("source"),s,!1,i,e,a,!1,c,parseInt(r.attr("height"))),d=p.firstGid;o.tileSheets[p.name]=p,t.find("tile").each(function(){var i=$(this),g=parseInt(i.attr("id"))+d;(r=i.find("image"))[0]&&(c=parseInt(r.attr("width")),e=c,a=parseInt(r.attr("height")),p=new ArcTileSheet(t.attr("name")+g,n+"/maps/"+r.attr("source"),s,!1,g,c,a,!1,c,a),o.tileSheets[p.name]=p);var u,f=i.find("animation");u=f.length>0?h(p,g,c,e,a,f.find("frame")):l(p,g,c,e,a),i.find("properties > property").each(function(){var t=$(this).attr("name"),i=$(this).attr("value")?$(this).attr("value"):$(this).text();"walkable"===t?u.walkable="false"!==i.toLowerCase():"drawable"===t?u.isDrawable="false"!==i.toLowerCase():"on"===t.substring(0,2)?u.properties[t]=Function("caller","time","player","world","worldAdapter",i):u.properties[t]=i})})});var c=!0;r.children().each(function(){var t=this.localName,i=$(this).attr("name");if("layer"===t){var a=$(this),r=parseInt(a.attr("width")),h=parseInt(a.attr("height")),p={};a.find("properties > property").each(function(){var t=$(this).attr("name").toLowerCase(),i=$(this).attr("value");"scrollx"!==t&&"scrolly"!==t||(i=parseInt(i)),p[t]=i});var d=new ArcTileMap(i,r,h,o.tileWidth,o.tileHeight,p.scrollx,p.scrolly);d.setTileSheet(this.tileSheets,this.tileWidth,this.tileHeight);var g=d,u=a.find("data").text().split(",");for(var f in u){var m=parseInt(u[f])-1;if(m>=0){var y=o.getTileSheetForTile(m);null!==y&&l(y,m,y.imageWidth,y.tileWidth,y.tileHeight);var M=f%r*o.tileWidth,b=Math.floor(f/r)*o.tileHeight,w=2*y.tileWidth,v=2*y.tileHeight;v>o.tileHeight&&(b=b-v+o.tileHeight),g.setTile(o.tiles[m],M,b,w,v).setTile=function(t){t>=0&&t<s.length&&(this.tile=s[t])}}}o.addChild(d,i)}else if("objectgroup"===t){let t=new QuadTree(0,0,o.width*o.tileWidth,o.height*o.tileHeight);"triggers"===i?(o.triggers=t,t.drawEnabled=!1,t.tickEnabled=!1,$(this).find("object").each(function(){o.addTrigger($(this),2,t,n,e)}),o.addChild(t,i)):"objects"===i&&(this.objects||(o.objects=t,o.waypointIndex=o.children.length,o.addChild(o.waypoint,"waypoint")),c=!1,$(this).find("object").each(function(){var t=$(this),i=t.attr("name"),e=t.attr("type")?t.attr("type"):"VillageObject",a=2*Number(t.attr("x")),r=2*Number(t.attr("y")),n=2*Number(t.attr("width")),s=2*Number(t.attr("height")),h=parseInt(t.attr("gid"))-1,c=null;Number.isNaN(n)&&(n=0),Number.isNaN(s)&&(s=0);var p={generated_scale:2,generated_map:o,generated_tileId:h};if(t.find("properties > property").each(function(){p[$(this).attr("name").toLowerCase()]=$(this).attr("value")?$(this).attr("value"):$(this).text()}),p.visible=!t.attr("visible")||"0"!=t.attr("visible"),h){h=parseInt(h);var d=o.getTileSheetForTile(h);if(null!==d){var g=l(d,h,d.imageWidth,2*d.tileWidth,2*d.tileHeight).drawable();n=Math.round(0==n?2*g.width:n),r-=(s=Math.round(0==s?2*g.height:s))>>1,a+=n>>1}}var u=window[e];u&&u.isVillageObject&&(c=new u(i,e,[a,r],[n,s],0,p,t),o.objects.insert(c))}),o.addChild(t,i))}});var p=[0,0];if(i){var d=o.getChild("objects").getByName(i);null!==d&&(p[0]=d.location[4],p[1]=d.location[5])}o.loaded=!0,t&&null!==t&&t(o,p)})},VillageMap.prototype.getClosestTileCoord=function(t,i){return[Math.round(t/this.tileWidth),Math.round(i/this.tileHeight)]},VillageMap.prototype.isBlocked=function(t,i,e,a,r,n){let o=null,s=null;for(var l=this.waypointIndex-1;l>-1;--l)if((s=this.children[l]).isBlocked&&null!==(o=this.children[l].isBlocked(t,i,e,a,r,n)))return o;return!1},VillageMap.prototype.trigger=function(t,i,e,a,r){let n=null;for(var o=this.waypointIndex-1;o>-1;--o)(n=this.children[o]).trigger(t,i,e,a,r)};var VillageModule=ArcBaseObject();VillageModule.prototype.init=function(t,i,e,a,r){this.path=t,this.maps={},this.onMapChange=r,this.css=t+"/css/style.css",this.spriteSheets={},this.gameContext=e,this.backgroundMusic=null,this.loadSpritesheets(t+"/sprites/");var n=new VillageMap(this,i);this.maps[i]=n,this.currentMap=n,this.dialog=arcGetDialogAdapter(t+"/scenes/dialog.csv"),n.load(a,"MainStart",e)},VillageModule.prototype.setBackgroundMusic=function(t,i){if(this.backgroundMusic){if(t===this.backgroundMusic)return;this.gameContext.audio.stopSound(this.backgroundMusic,i)}this.backgroundMusic=t,this.gameContext.audio.playSound(this.backgroundMusic,i)},VillageModule.prototype.loadSpritesheets=function(t){var i=this;$.ajax({url:t+"sprites.json",method:"GET",async:!1,success:function(e){var a=e;"string"==typeof a&&(a=JSON.parse(e));var r={};for(var n in a.animations){var o={};for(var s in a.animations[n]){for(var l=a.animations[n][s],h=new ArcAnimation,c=0;c<l.length;++c){var p=l[c];h.addFrame(p.x,p.y,p.width,p.height,p.time,!1,!1)}o[s]=h}r[n]=o}for(var n in a.sprites){var d=a.sprites[n],g=new ArcSpriteSheet(t+d.image,!1);g.id=n;h=r[d.animation];for(var s in h)g.setAnimation(s,h[s]);i.spriteSheets[n]=g}}})},VillageModule.prototype.getSpriteSheet=function(t){return this.spriteSheets[t]},VillageModule.prototype.load=function(t,i,e=!0){var a=this,r=this.maps[t];r&&null!==r||(r=new VillageMap(this,t),this.maps[t]=r),i&&null!==i&&i.length>0||(i="MainStart"),e&&r.load(function(t,i){var e=t.parent;e.currentMap.name,e.currentMap=t,e.onMapChange&&e.onMapChange(e.currentMap,i)},i,a.gameContext)};var MiniMap=ArcBaseObject();MiniMap.prototype=Object.create(ArcRenderableObject.prototype),MiniMap.prototype.init=function(t,i,e,a,r,n){this.tickEnabled=!0,this.drawEnabled=!0,this.canvas=document.createElement("canvas"),this.mapCanvas=document.createElement("canvas"),this.scale=1,this.name=null,this.location=new Float32Array(6),this.size=new Uint16Array(4),this.offset=new Float32Array(2),this.map=null,this.mask=r,this.image=n,this.opacity=1,this.quadrant=0,this.quadrantWidth=0,this.quadrantHeight=0,this.resize(t,i,e,a),this.updateSize(t,i)},MiniMap.prototype.resize=function(t,i,e,a){this.canvas.width=e,this.canvas.height=a,this.mapCanvas.width=t,this.mapCanvas.height=i,this.context=this.canvas.getContext("2d"),this.mapContext=this.mapCanvas.getContext("2d"),this.mapContext.globalCompositeOperation="destination-over",this.quadrantWidth=t>>1,this.quadrantHeight=i>>1;let r=this.context;r.mozImageSmoothingEnabled=!1,r.webkitImageSmoothingEnabled=!1,r.msImageSmoothingEnabled=!1,r.imageSmoothingEnabled=!1},MiniMap.prototype.draw=function(t,i,e,a,r){let n=this.canvas;n.complete=!1;let o=this.map,s=this.context,l=1/o.tileWidth,h=this.mapCanvas.width*o.tileWidth>>1,c=this.mapCanvas.height*o.tileHeight>>1,p=this.location,d=this.size;switch(s.globalAlpha=this.opacity,this.beginDraw(),this.quadrant){case 0:this.mapContext.clearRect(0,0,this.quadrantWidth,this.quadrantHeight),o.drawMinimap(this,this.offset[0],this.offset[1],h,c,0,0,l);break;case 1:this.mapContext.clearRect(this.quadrantWidth,0,this.quadrantWidth,this.quadrantHeight),o.drawMinimap(this,this.offset[0]+h,this.offset[1],h,c,this.quadrantWidth,0,l);break;case 2:this.mapContext.clearRect(this.quadrantWidth,this.quadrantHeight,this.quadrantWidth,this.quadrantHeight),o.drawMinimap(this,this.offset[0]+h,this.offset[1]+c,h,c,this.quadrantWidth,this.quadrantHeight,l);break;case 3:this.mapContext.clearRect(0,this.quadrantHeight,this.quadrantWidth,this.quadrantHeight),o.drawMinimap(this,this.offset[0],this.offset[1]+c,h,c,0,this.quadrantHeight,l)}this.endDraw(),s.clearRect(0,0,n.width,n.height),s.drawImage(this.mask,0,0,n.width,n.height),s.globalCompositeOperation="source-atop",s.drawImage(this.mapCanvas,0,0,n.width,n.height),s.globalCompositeOperation="source-over",s.drawImage(this.image,0,0,n.width,n.height),n.complete=!0,t.updateImage(n),t.drawImage(n,0,0,n.width,n.height,p[0],p[1],d[0],d[1])},MiniMap.prototype.tick=function(t,i,e){if(this.map=e,i.user){let t=this.mapCanvas,a=e.players[i.user.id].location,r=t.width*e.tileWidth,n=t.height*e.tileHeight;this.offset[0]=a[4]-(r>>1),this.offset[1]=a[5]-(n>>1),e.waypoint.isVisible?this.opacity=Math.max(.6,this.opacity-.05):this.opacity=Math.min(1,this.opacity+.05)}this.quadrant=(this.quadrant+1)%4},MiniMap.prototype.beginDraw=function(){this.mapContext.beginPath()},MiniMap.prototype.fillRect=function(t,i,e,a,r){let n=this.mapContext;n.fillStyle!=t&&(n.fill(),n.closePath(),n.fillStyle=t,n.beginPath()),n.rect(i,e,a,r)},MiniMap.prototype.fillTriangle=function(t,i,e,a,r,n,o){let s=this.mapContext;s.fillStyle!=t&&(s.fill(),s.closePath(),s.fillStyle=t,s.beginPath()),s.moveTo(i,e),s.lineTo(a,r),s.lineTo(n,o),s.lineTo(i,e)},MiniMap.prototype.endDraw=function(){this.mapContext.fill(),this.mapContext.closePath()};var quadMinimap=function(t){t.drawMinimap&&t.drawMinimap(quadMinimap.args[0],quadMinimap.args[1],quadMinimap.args[2],quadMinimap.args[3],quadMinimap.args[4],quadMinimap.args[5],quadMinimap.args[6],quadMinimap.args[7])};quadMinimap.args=null;var tileMinimap=function(t){t.drawMinimap&&t.drawMinimap(tileMinimap.args[0],tileMinimap.args[1],tileMinimap.args[2],tileMinimap.args[3],tileMinimap.args[4],tileMinimap.args[5],tileMinimap.args[6],tileMinimap.args[7])};tileMinimap.args=null,QuadTree.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){quadMinimap.args=arguments,this.getObjects(i,e,a,r,!1,quadMinimap)},ArcTileMap.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){tileMinimap.args=arguments,this.data.getObjects(i,e,a,r,!1,tileMinimap)},ArcTileQuadTree_Tile.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){if(this.tile.properties.minimap&&this.inLocation(i,e,i+a,e+r)){let a=Math.floor((this.location[0]-i)*s)+n,r=Math.floor((this.location[1]-e)*s)+o;t.fillRect(this.tile.properties.minimap,a,r,this.size[0]*s,this.size[1]*s)}},VillageMap.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){let l,h;for(h=this.children.length-1;h>=0;--h)(l=this.children[h]).drawMinimap&&l.drawMinimap(t,i,e,a,r,n,o,s);return!1},NPC.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){if(this.inLocation(i,e,i+a,e+r)){let a=this.collisionBox(),r=Math.floor((a[0]-i)*s)+n,l=Math.floor((a[1]-e)*s)+o,h=this.fov;if(h.enabled){let i,e,n=r+(a[2]>>1)*s,o=l+(a[3]>>1)*s;e=Math.tan(h.angle)*(h.distance*s),0==this.direction?(i=o+h.distance*s,t.fillTriangle("#F80",n,o,n+e,i,n-e,i)):1==this.direction?(i=n-h.distance*s,t.fillTriangle("#F80",n,o,i,o+e,i,o-e)):2==this.direction?(i=o-h.distance*s,t.fillTriangle("#F80",n,o,n+e,i,n-e,i)):3==this.direction&&(i=n+h.distance*s,t.fillTriangle("#F80",n,o,i,o+e,i,o-e))}t.fillRect("#FF0",r,l,a[2]*s,this.size[3]*s)}},User.prototype.drawMinimap=function(t,i,e,a,r,n,o,s){let l=this.lastCollisionBox,h=Math.round((l[0]-i)*s)+n,c=Math.round((l[1]-e)*s)+o;t.fillRect("#0CF",h,c,l[2]*s,this.size[3]*s)};var VillageDisplay=ArcBaseObject();{function handleKeyDown(t){var i=ArcSettings.Current.gameplay.controls;(t==i.up[0]||i.up[1])&&(this.playerKeys.up=!0),(t==i.down[0]||i.down[1])&&(this.playerKeys.down=!0),(t==i.left[0]||i.left[1])&&(this.playerKeys.left=!0),(t==i.right[0]||i.right[1])&&(this.playerKeys.right=!0)}function handleKeyUp(t){var i=ArcSettings.Current.gameplay.controls;(t==i.up[0]||i.up[1])&&(this.playerKeys.up=!1),(t==i.down[0]||i.down[1])&&(this.playerKeys.down=!1),(t==i.left[0]||i.left[1])&&(this.playerKeys.left=!1),(t==i.right[0]||i.right[1])&&(this.playerKeys.right=!1)}VillageDisplay.prototype.init=function(t,i,e,a){this.playerStart=[0,0],this.player=null,this.world=null,this.timestamp=null,this.offset=[0,0],this.halfDim=[0,0],this.maxOffset=[0,0],this.dimension=[0,0],this.worldAdapter=i,this.drawWorldFunction=a,this.display=t.display,this.game=t,this.drawLow=[],this.drawHigh=[],this.drawObjects=[],this.playerKeys={up:!1,down:!1,left:!1,right:!1}},VillageDisplay.prototype.clearLayerGroup=function(t,i){if(t.length===i)for(e=0;e<i;++e)t[e].length=0;else{t.length=0;for(var e=0;e<i;++e)t.push([])}return t},VillageDisplay.prototype.triggerDraw=function(){var t=this.offset;null!==this.world&&t&&(this.player&&this.player.user?this.drawWorldFunction(this.player.user.location,t[0],t[1],this.world):this.drawWorldFunction(t,t[0],t[1],this.world))},VillageDisplay.prototype.handleActions=function(t){for(var i=this.player,e=this.offset,a=null,s=0;s<t.length;++s)if(a=t[s],null!==i&&i.user)switch(a.id){case CONTROL_KEY_DOWN:handleKeyDown.call(this,a.data.key);break;case CONTROL_KEY_UP:handleKeyUp.call(this,a.data.key);break;case CONTROL_MOUSE1_DOWN:i.waypointLoc[0]=e[0]+a.data.x,i.waypointLoc[1]=e[1]+a.data.y,i.showWaypoint=!0;break;case CONTROL_MOUSE1_UP:i.waypointLoc[0]=e[0]+a.data.x,i.waypointLoc[1]=e[1]+a.data.y,i.showWaypoint=!0,this.world.click(i.waypointLoc[0],i.waypointLoc[1],i,this.world);break;case CONTROL_MOUSE1_DRAG:i.waypointLoc[0]=e[0]+a.data.x,i.waypointLoc[1]=e[1]+a.data.y,i.showWaypoint=!0}},VillageDisplay.prototype.updateWorld=function(t,i,e){this.readWorldState(i,e)},VillageDisplay.prototype.tick=function(t,i){var e=null,a=this.offset,s=null;this.player&&this.player.user?(e=this.player.user,s=this.halfDim,a[0]=e.location[4]-s[0],a[1]=e.location[5]-s[1]):i?(a[0]=i[0],a[1]=i[1]):(a[0]=0,a[1]=0),s=this.dimension,a[0]<0?a[0]=0:a[0]>this.maxOffset[0]-s[0]&&(a[0]=this.maxOffset[0]-s[0]),a[1]<0?a[1]=0:a[1]>this.maxOffset[1]-s[1]&&(a[1]=this.maxOffset[1]-s[1]),null!==e&&(this.player.tick(t,this.worldAdapter,this.world),this.player.showWaypoint?this.world.setWaypointLocation(this.player.waypointLoc):this.world.setWaypointLocation(null)),this.world.tick(t,this.worldAdapter,this.world,this.player)},VillageDisplay.prototype.resize=function(t,i){this.dimension[0]=t,this.dimension[1]=i,this.halfDim[0]=t/2,this.halfDim[1]=i/2},VillageDisplay.prototype.setPlayer=function(t,i,e,a,s,l){this.addUser(t,i,e,a,s,l);this.player=t},VillageDisplay.prototype.readWorldState=function(t){var i=this.player,e="number"==typeof i,a=this.world;if(e){e=!1;let t=a.players;t[i]&&(this.player=new Player(t[i]),i=this.player)}else e=null!==i;switch(this.timestamp=t.timestamp,t.type){case WORLD_SNAPSHOT:this.handleWorldSnapshot(t.world,t.playerStart);break;case WORLD_ACTIONLIST:for(var s=0;s<t.actions.length;++s)this.handleServerAction(t.actions[s])}},VillageDisplay.prototype.handleWorldSnapshot=function(t,i){this.world=t,this.playerStart[0]=i[0],this.playerStart[1]=i[1],this.maxOffset[0]=t.width*t.tileWidth-1,this.maxOffset[1]=t.height*t.tileHeight-1;let e=t.players;for(a in e)e[a];null!==this.player&&this.player.user&&(this.player.user.updateLocation(this.playerStart[0],this.playerStart[1]),this.player.waypointLoc[0]=this.playerStart[0],this.player.waypointLoc[1]=this.playerStart[1],t.addPlayer(this.player.user));for(var a in t.tileSheets){var s=t.tileSheets[a];this.display.addExistingTileSheet(s.name,s)}},VillageDisplay.prototype.handleModifyMap=function(t){},VillageDisplay.prototype.handleMoveUser=function(t){var i=world.getChild("players").getChild(t.id);i&&(i.updateLocation(t.location[0],t.location[1]),i.setAnimation(t.animation))},VillageDisplay.prototype.handleServerAction=function(t){switch(t.type){case ACTION_MODIFY_MAP:this.handleModifyMap(t.map);break;case ACTION_ADD_USER:i=t.user;this.isPlayer(i.id)||this.addUser(i.id,i.name,i.location,i.spriteSheet.id,i.spriteSheet.palette,i.spriteSheet.animations);break;case ACTION_MOVE_USER:var i=t.user;this.isPlayer(i.id)||this.handleMoveUser(t.user)}},VillageDisplay.prototype.isPlayer=function(t){return null!==this.player&&("number"!=typeof this.player&&this.player.user.id===t)},VillageDisplay.prototype.addSpriteSheet=function(t){this.display.addSpriteSheet(t.id,t.baseImage.src,t.animations,palette)},VillageDisplay.prototype.addUser=function(t,i,e,a,s,l){let r=this.world.players[t];r||(r=new User(t,i)),r.updateLocation(e[0],e[1]);var o=this.worldAdapter.getSpriteSheet(a).copy();o.id=a+r.id;for(var h in l)o.setAnimation(h,l[h]);return this.display.addSpriteSheet(o.id,o.baseImage.src,o.animations,s),r.spriteSheet=o,this.world.addPlayer(r),r}}VillageConfig.googleAnalytics&&(!function(t,e,a,s,r,i,n){t.GoogleAnalyticsObject=r,t[r]=t[r]||function(){(t[r].q=t[r].q||[]).push(arguments)},t[r].l=1*new Date,i=e.createElement(a),n=e.getElementsByTagName(a)[0],i.async=1,i.src="https://www.google-analytics.com/analytics.js",n.parentNode.insertBefore(i,n)}(window,document,"script",0,"ga"),ga("create",VillageConfig.googleAnalytics,"auto"),ga("send","pageview"));var testSpriteList=["./Resources/Charactersets/dancer_male_palette.png","./Resources/Charactersets/dancer_male_large2.png","./Resources/Charactersets/dancer_male_large.png","./Resources/Charactersets/base_male_large.png","./Resources/Charactersets/base_female_large.png"],idPrefix="id_";WorldAdapter.prototype.init=function(t,e,a){function s(e,a){this.playerStart=a.splice();var s={type:WORLD_SNAPSHOT,timestamp:Date.now(),playerStart:a,world:e};t&&t(s)}var r=this,i=[];this.playerStart=[0,0],this.module=null,this.user=null,this.module=new VillageModule(VillageConfig.baseUrl+arcGetParameter("module"),arcGetParameter("mapname"),a,s,s),this.showMessage=function(t,a,s,i,n){return e(r.module.dialog,t,a,s,i,n)},this.config=new ArcConfig(this.module.path+"/config.json"),$(function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("link");e.id="module_style",e.rel="stylesheet",e.type="text/css",e.href=r.module.css,e.media="all",t.appendChild(e)});i.sort(function(t,e){return t.timestamp-e.timestamp}),this.login=function(t){var e=Math.round(1e3*Math.random())+1e3,a=r.getSpriteSheetList()[Object.keys(r.getSpriteSheetList())[0]];return r.user={id:e,name:"Student "+e,location:[0,0],spriteSheet:{id:a.id,palette:a.palette,animations:a.animations},animation:"walk_down"},i.push({timestamp:Date.now(),action:{type:ACTION_ADD_USER,user:r.user}}),{userId:e,userName:"Test Player - "+t,isSuccessful:!0,message:"Login Successful for"+t+"!"}},this.logout=function(t){},this.requestWorldState=function(e){var a={type:WORLD_SNAPSHOT,timestamp:Date.now(),playerStart:this.playerStart,world:this.module.currentMap};t(a)},this.lastWorldActions={type:WORLD_ACTIONLIST,timestamp:Date.now(),actions:new ArcArrayBuffer},this.getWorldActions=function(t){var e=this.lastWorldActions;for(e.timestamp=Date.now(),e.actions.length=0;i.length>0&&i[0].timestamp<e.timestamp;)e.actions.push(i.shift().action);return e},this.postWorldActions=function(t){},this.getSpriteSheet=function(t){return this.getSpriteSheetList()[t]}},WorldAdapter.prototype.getSpriteSheetList=function(){return this.module.spriteSheets},WorldAdapter.prototype.getTaskScript=function(t){return this.module.path+"/tasks/"+t+".js"},WorldAdapter.prototype.getConfigSetting=function(t){this.config.getEntry(t)};var VillageSettings=ArcBaseObject();VillageSettings.prototype=Object.create(ArcSettings.prototype),VillageSettings.prototype.init=function(t){ArcSettings.prototype.init.call(this,t),this.audio={volume:1},this.video={resolution:[800,600],fps:30},this.gameplay={controls:{up:[38,87],down:[40,83],left:[37,65],right:[39,68],select:[13]}}},VillageSettings.prototype.save=function(t){this.audio.volume=t.audio.getVolume(),ArcSettings.prototype.save.call(this)},VillageSettings.prototype.load=function(t){ArcSettings.prototype.load.call(this,t),t.audio.setVolume(this.audio.volume),t.setFrameCap(this.video.fps)};var VillageGame=ArcBaseObject();VillageGame.prototype=Object.create(ArcGame.prototype),VillageGame.prototype.init=function(t,e,i){ArcGame.prototype.init.call(this,t,null,null,null,30,!0);var a=this;a.timestamp=-1;var l=null,o=!1,n=null,s=null,r=new VillageSettings("arc.ualberta.villagegame");r.load(this),ArcSettings.Current=r,this.villageDisplay=null,this.hud=new ArcRenderableObject(!0,!0),Character.VisionCone.src=i+"/Icons/VisionCone.png";var c=function(e){let i=new Image;i.src=e.module.path+"/images/map_mask.png";let l=new Image;l.src=e.module.path+"/images/map_container.png";let o=new MiniMap(40,40,256,256,i,l);o.updateSize(Math.floor(t.width/4),Math.floor(t.width/4)),o.updateLocation(t.width-o.size[2]-5,o.size[3]+5),a.hud.addChild(o,"Mini Map")},d=[];for(var u in d)this.audio.updateSound(d[u],[-1e4,-1e4]),this.audio.loadSound(d[u],!0,function(t){alert("Could not load sound due to: "+t)});var p=function(){var t=a.control.pullActionList();o?o.handleActions(t):a.villageDisplay.handleActions(t)};this.beginLoopListeners.push(function(t,e){p();var i=l.getWorldActions(a.timestamp);a.villageDisplay.updateWorld(e,i)}),this.updateListeners.push(function(t,e){o&&o.animate(e),a.villageDisplay.tick(e,a.display.camera.offset),a.hud.tick(e,l,l.module.currentMap)}),this.drawListeners.push(function(t){a.villageDisplay.triggerDraw()});var h=function(t){for(var e in d)a.audio.updateSound(d[e],t)},g=function(t,e,i,l){var o=a.display;o.camera.setOffset(e,i);if(h(t),o.clear(),null!=l){let n=o.size;l.draw(o,e,i,n[0],n[1]),t[4]&&a.hud.draw(o,e,i,n[0],n[1])}o.drawToDisplay("UNKNOWN")};this.currentTask=null,this.loadTask=function(e,i,n){return o=new TaskMenu(e,t.width-100,t.height-50),a.currentTask=new TaskScript(o.canvas,e,i,l.module.path,a.taskWorker),o.task=a.currentTask,recordEvent("Task","Open",e),o.task.setTitle=function(t){o.setTitle(t)},o.task.close=function(){recordEvent("Task","Close",e),o.close(),o=!1},o.closeComplete=function(){n&&n(o),o=null},o.show(t),a.currentTask},this.setVolume=function(t){this.audio.setVolume(t)};var m=function(t){a.display.camera.clearActions();var e=[400,300],i=a.villageDisplay.world.objects.getByName("MainStart");i&&(e[0]=i.centre[0],e[1]=i.centre[1]);var r=[];r.push({timestamp:Date.now(),action:{type:ACTION_ADD_USER,user:{id:n,name:s,location:e,spriteSheet:t.getSimple(),animation:"walk_down"}}}),l.postWorldActions(r),a.villageDisplay.setPlayer(n,s,e,t.id,t.palette,t.getSimpleAnimations()),o=!1},w=function(e){var a=new Image;a.src=i+"/Icons/options.gif",$(a).click(function(){o||(o=SettingsWindow(game),recordEvent("Settings","Open"),o.closeComplete=function(){recordEvent("Settings","Close"),o=null},o.show(t))}),e.append(a)};this.worldMetaData={width:1,height:1,tileWidth:32,tileHeight:32};var f=function(t){if(null==a.userId){var e=a.worldMetaData.width*a.worldMetaData.tileWidth*.5,i=a.worldMetaData.height*a.worldMetaData.tileHeight*.7,l=Math.random(),o=Math.random()*e,n=800,s=Math.random()*i;l>.5?n+=o:n=(o+=e)-n,t.addAction(new ArcCameraPanAction(1e4,f,o,s,n,s))}};this.start=function(){var r=$("<div class='game_iconPanel'></div>");if($(t).after(r),w(r),l=new WorldAdapter(function(t){var e=t.world;a.worldMetaData.width=e.width,a.worldMetaData.height=e.height,a.worldMetaData.tileWidth=e.tileWidth,a.worldMetaData.tileHeight=e.tileHeight,a.timestamp=t.timestamp,a.display.tiles=t.world.tiles,a.villageDisplay.readWorldState(t)},function(e,i,a,l,n,s){return o=new DialogMenu(e,i,a||1,l,n),recordEvent("Dialog","Open",i),o.closeComplete=function(){recordEvent("Dialog","Close",i),o=null,s&&s()},o.show(t),o},a),l.loadTask=a.loadTask,c(l),a.villageDisplay=new VillageDisplay(a,l,e+"/village_worker.js",g),a.villageDisplay.resize(t.width,t.height),l.config.containsKey("title.music")){var d=new ArcSound("titleMusic",!0,l.module.path+l.config.getEntry("title.music"));l.module.setBackgroundMusic(d,0)}(o=new LoginMenu(l.login,i)).show(t),o.closeComplete=function(){n=o.userId,s=o.userName,l.requestWorldState(n),(o=new CharacterSelectMenu(l.getSpriteSheetList())).characterSelected=m,o.show(t)},l.requestWorldState(null),f(this.display.camera),ArcGame.prototype.start.call(this)},$(window).resize(function(e){a.villageDisplay.resize(t.width,t.height)})},VillageGame.prototype.resize=function(t,e){if(ArcGame.prototype.resize.call(this,t,e),this.hud){let t=this.canvas,e=this.hud.getChild("Mini Map");e.updateSize(Math.floor(t.width/4),Math.floor(t.width/4)),e.updateLocation(t.width-e.size[2]-5,e.size[3]+5)}},VillageGame.prototype.fullscreen=function(){this.display.requestFullscreen()};